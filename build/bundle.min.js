"use strict";var Util={};Util.comma=d3.format(",.0f"),Util.decimalOne=d3.format(".1f"),Util.decimalTwo=d3.format(".2f"),Util.percentize=d3.format("%"),Util.percentizeDec=d3.format(".1%"),Util.monetize=d3.format("$,f"),Util.formatSI=d3.format(".2s"),Util.scrollTo=function(t){document.getElementById(t).scrollIntoView()},Util.strToFloat=function(t){return"string"!=typeof t?t:parseFloat(t.replace(/[^\d\.\-]/g,""))},Util.capitalize=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},Util.getIndicatorClass=function(t){return t.split(".").join("-")},Util.getIndicatorId=function(t){return t.split("-").join(".")},Util.sortByKey=function(t,n,e){return t.sort(function(t,e){return t[n]<e[n]?-1:t[n]>e[n]?1:0}),e?t.reverse():t},Util.truncateText=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:30,n=t.split(" ");if(1===n.length||t.length<=e)return t;for(var r="",a=0,i=0;i<n.length&&a+n[i].length<e;)0<i&&(r+=" "),r+=n[i],a+=n[i].length,i++;return r+"..."},Util.populateSelect=function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};void 0===n.valKey&&(n.valKey=""),void 0===n.nameKey&&(n.nameKey="");var r=d3.select(t).selectAll("option").data(e);r.exit().remove(),r=r.enter().append("option").merge(r).attr("value",function(t){return"function"==typeof n.valKey?n.valKey(t):""===n.valKey?t:t[n.valKey]}).text(function(t){return"function"==typeof n.nameKey?n.nameKey(t):""===n.nameKey?t:t[n.nameKey]}),n.selected&&("boolean"==typeof n.selected?r.attr("selected",n.selected):"function"==typeof n.selected&&r.attr("selected",function(){if(n.selected($(this).attr("value")))return!0}))},Util.strToFloat=function(t){return"string"!=typeof t?t:parseFloat(t.replace(/[^\d\.\-]/g,""))},Util.getInputNumVal=function(t){var e=$(t),n=Util.strToFloat(e.val());return""===n?0:isNaN(n)||n<0?(e.val(0),0):(e.val(d3.format(",")(n)),n)},Util.msieversion=function(){return!!(0<window.navigator.userAgent.indexOf("MSIE ")||navigator.userAgent.match(/Trident.*rv\:11\./))};var User={targetScoreType:"target",targetScore:4,buyOrLease:"lease"},App={demoMode:!1,scoreLabels:{1:"No Capacity",2:"Limited Capacity",3:"Developed Capacity",4:"Demonstrated Capacity",5:"Sustainable Capacity"},initialize:function(o){var t=navigator.userAgent;-1===t.search("Chrome")&&-1===t.search("Firefox")&&noty({timeout:!1,maxWidth:400,text:"<b>Warning!<br>This tool is designed to be used in Google Chrome or Mozilla Firefox! Please switch to one of these browsers for optimal performance.</b>"}),$(".tool-name").click(function(){return hasher.setHash("")}),$(".nav-item").click(function(){var t=$(this).attr("page");void 0!==t&&hasher.setHash(t)}),$(".dropdown-item").click(function(){hasher.setHash($(this).attr("page"))}),d3.queue().defer(d3.json,"data/country_specific_parameters.json").defer(d3.json,"data/jee_costing_data.json").defer(d3.json,"data/currencies.json").defer(d3.json,"data/global_base_costs.json").defer(d3.json,"data/global_staff_multipliers.json").await(function(t,e,n,r,a,i){t?noty({type:"error",text:"Error loading data files. Please contact the tool administrator"}):(App.countryParams=e,App.jeeTree=n,App.currencies=r,App.globalBaseCosts=a,App.globalStaffMultipliers=i,App.whoAmI={},App.demoMode?d3.text("data/KE20170904-demo.ihr",function(t,e){App.loadSessionData(e)||noty({text:"There was an issue loading the demo data."}),App.updateAllCosts(),o()}):(App.updateAllCosts(),o()))})},siFormat:function(t){return d3.format(",.3s")(t).replace("G","B")},numberFormat:function(t){return t<=100?Math.round(t):t<=1e6?d3.format(",.3r")(t):App.siFormat(t)},moneyFormat:function(t){return App.numberFormat(t)+" "+App.whoAmI.currency_iso},moneyFormatShort:function(t){return App.siFormat(t)+" "+App.whoAmI.currency_iso},moneyFormatLong:function(t){return d3.format(",")(t)+" "+App.whoAmI.currency_iso},normalCcIds:["p","d","r"],getCapacity:function(t){var e=t.includes(".")?t.split(".")[0].toLowerCase():"o",n=t.toLowerCase(),r=App.jeeTree.find(function(t){return t.id===e});return r?r.capacities.find(function(t){return t.id===n}):null},getIndicator:function(t){var e=App.normalCcIds.includes(t.split(".")[0])?2:1,n=t.split(".").slice(0,e).join(".").toLowerCase(),r=t.toLowerCase(),a=App.getCapacity(n);return a?a.indicators.find(function(t){return t.id===r}):null},getPrevIndicator:function(e,n){var r=e.includes(".")?e.split(".")[0].toLowerCase():"o",t=App.jeeTree.findIndex(function(t){return t.id===r}),a=App.jeeTree[t],i=a.capacities.findIndex(function(t){return t.id===e}),o=a.capacities[i],s=o.indicators.findIndex(function(t){return t.id===n});if(0<s)return o.indicators[s-1];if(0<i){var c=a.capacities[i-1];return c.indicators[c.indicators.length-1]}if(0<t){var l=App.jeeTree[t-1],p=l.capacities[l.capacities.length-1];return p.indicators[p.indicators.length-1]}return null},getNextIndicator:function(e,n){var r=e.includes(".")?e.split(".")[0].toLowerCase():"o",t=App.jeeTree.findIndex(function(t){return t.id===r}),a=App.jeeTree[t],i=a.capacities.findIndex(function(t){return t.id===e}),o=a.capacities[i],s=o.indicators.findIndex(function(t){return t.id===n});return s<o.indicators.length-1?o.indicators[s+1]:i<a.capacities.length-1?a.capacities[i+1].indicators[0]:t<App.jeeTree.length-1?App.jeeTree[t+1].capacities[0].indicators[0]:null},getAction:function(t){var e=App.normalCcIds.includes(t.split(".")[0])?3:2,n=t.split(".").slice(0,e).join(".").toLowerCase(),r=t.toLowerCase(),a=App.getIndicator(n);return a?a.actions.find(function(t){return t.id===r}):null},getInput:function(t){var e=App.normalCcIds.includes(t.split(".")[0])?4:3,n=t.split(".").slice(0,e).join(".").toLowerCase(),r=t.toLowerCase(),a=App.getAction(n);return a?a.inputs.find(function(t){return t.id===r}):null},getLineItem:function(t){var e=App.normalCcIds.includes(t.split(".")[0])?5:4,n=t.split(".").slice(0,e).join(".").toLowerCase(),r=t.toLowerCase(),a=App.getInput(n);return a?a.line_items.find(function(t){return t.id===r}):null},getNeededActions:function(e){return e.score?e.actions.filter(function(t){return App.getNeededInputs(t.inputs,e.score).length}):[]},getNeededInputs:function(t,e){return e?t.filter(function(t){return App.getNeededLineItems(t.line_items,e).length}):t},getNeededLineItems:function(t,e){if(!e)return t;if("step"===User.targetScoreType)return t.filter(function(t){return t.score_step_to.includes(String(+e+1))});if("target"===User.targetScoreType){var n=d3.range(+e+1,User.targetScore+1);return t.filter(function(t){for(var e=0;e<t.score_step_to.length;e++)if(n.includes(+t.score_step_to[e]))return!0;return!1})}return[]},getIndicatorScore:function(t){return App.getIndicator(t).score},getAverageCurrentScore:function(t){var e=[];return t.forEach(function(t){t.score&&e.push(t.score)}),d3.mean(e)},getAverageTargetScore:function(t){var e=[];return t.forEach(function(t){t.score&&e.push(App.getTargetScore(t))}),d3.mean(e)},getTargetScore:function(t){if("step"===User.targetScoreType){if(t.score)return 4<=t.score?t.score:t.score+1}else if("target"===User.targetScoreType)return t.score&&t.score>User.targetScore?t.score:User.targetScore;return null},setIndicatorScore:function(t,e){App.getIndicator(t).score=e},updateAllCosts:function(){var n=App.getExchangeRate();App.jeeTree.forEach(function(e){e.startupCost=0,e.capitalCost=0,e.recurringCost=0,e.capacities.forEach(function(t){t.startupCost=0,t.capitalCost=0,t.recurringCost=0,t.indicators.forEach(function(e){e.startupCost=0,e.capitalCost=0,e.recurringCost=0,e.actions.forEach(function(t){t.startupCost=0,t.capitalCost=0,t.recurringCost=0,t.inputs.forEach(function(e){e.startupCost=0,e.capitalCost=0,e.recurringCost=0,e.line_items.forEach(function(t){t.cost=App.getLineItemCost(t,n),"start-up"===t.line_item_type?e.startupCost+=t.cost:"capital"===t.line_item_type?e.capitalCost+=t.cost:"recurring"===t.line_item_type&&(e.recurringCost+=t.cost)}),e.costed&&(e.isCustomCost?(t.startupCost+=e.customStartupCost,t.recurringCost+=e.customRecurringCost):(t.startupCost+=e.startupCost,t.capitalCost+=e.capitalCost,t.recurringCost+=e.recurringCost))}),App.isActionComplete(t,e.score)&&(e.startupCost+=t.startupCost,e.capitalCost+=t.capitalCost,e.recurringCost+=t.recurringCost)}),t.startupCost+=e.startupCost,t.capitalCost+=e.capitalCost,t.recurringCost+=e.recurringCost}),e.startupCost+=t.startupCost,e.capitalCost+=t.capitalCost,e.recurringCost+=t.recurringCost})})},getLineItemCost:function(e,t){var n=App.globalBaseCosts.find(function(t){return t.id===e.base_cost});if(!n)if(n=App.globalBaseCosts.find(function(t){return t.id===e.base_cost+"."+User.buyOrLease}),"buy"===User.buyOrLease)e.line_item_type="start-up",e.score_step_to=[String(d3.min(e.score_step_to))];else{e.line_item_type="recurring";for(var r=[],a=+d3.min(e.score_step_to);a<5;a++)r.push(String(a));e.score_step_to=r.slice(0)}if(!n)return console.log("Warning! Cost object not found for id: "+e.base_cost),0;var i=n?n.cost:0;if(e.staff_multiplier){var o=App.globalStaffMultipliers.find(function(t){return t.id===e.staff_multiplier});o&&(i*=o.count)}if(e.country_multiplier&&App.whoAmI.name){var s=1;if("intermediate_1_and_local_area_count"===e.country_multiplier)s=App.whoAmI.multipliers.intermediate_1_area_count+App.whoAmI.multipliers.local_area_count;else if("intermediate_1_and_2_count"===e.country_multiplier){var c=App.whoAmI.multipliers.intermediate_2_area_count;null==c&&(c=0),s=App.whoAmI.multipliers.intermediate_1_area_count+App.whoAmI.multipliers.intermediate_2_area_count}else s=App.whoAmI.multipliers[e.country_multiplier];s&&(i*=s)}return e.custom_multiplier_1&&(i*=App.getMultiplierValue(e.custom_multiplier_1)),e.custom_multiplier_2&&(i*=App.getMultiplierValue(e.custom_multiplier_2)),n&&"Salaries"===n.subheading_name&&(i*=1+App.whoAmI.staff_overhead_perc),i*=t||App.getExchangeRate(),Math.round(i)},getCostText:function(t){var e=t.startupCost+t.capitalCost,n=t.recurringCost;return n?App.moneyFormat(e)+" + "+App.moneyFormat(n)+"/yr":App.moneyFormat(e)},getCustomCostText:function(t){return t.isCustomCost?App.moneyFormat(t.customStartupCost)+" + "+App.moneyFormat(t.customRecurringCost)+"/yr":""},getNumIndicatorsCosted:function(t){return t.indicators.filter(function(t){return App.isIndicatorComplete(t)}).length},getExchangeRate:function(){return App.whoAmI.name?App.currencies[App.whoAmI.currency_iso].exchange_rates.find(function(t){return"USD"===t.convert_from}).multiplier:1},getMultiplierValue:function(t){if("number"==typeof t)return t;var e=t.split(" ");return parseFloat(e[0])},isIndicatorComplete:function(e){return!!e.score&&App.getNeededActions(e).every(function(t){return App.isActionComplete(t,e.score)})},isActionComplete:function(t,e){return!!e&&App.getNeededInputs(t.inputs,e).every(function(t){return t.costed})},getCompleteIndicatorTree:function(){var e=[];return App.jeeTree.forEach(function(t){t.capacities.forEach(function(t){t.indicators.forEach(function(a){if(App.isIndicatorComplete(a)){var i=Object.assign({},a),t=App.getNeededActions(i);i.targetScore=App.getTargetScore(i),i.actions=[],t.forEach(function(t){if(App.isActionComplete){var r=Object.assign({},t),e=r.inputs.filter(function(t){return t.costed}),n=App.getNeededInputs(e,a.score);r.inputs=[],n.forEach(function(t){var n=Object.assign({},t),e=App.getNeededLineItems(n.line_items,a.score);n.line_items=[],e.forEach(function(t){var e=Object.assign({},t);n.line_items.push(e)}),r.inputs.push(n)}),i.actions.push(r)}}),e.push(i)}})})}),e},getScoredIndicatorTree:function(){var e=[];return App.jeeTree.forEach(function(t){t.capacities.forEach(function(t){t.indicators.forEach(function(a){if(a.score){var i=Object.assign({},a),t=App.getNeededActions(i);i.targetScore=App.getTargetScore(i),i.actions=[],t.forEach(function(t){var r=Object.assign({},t),e=r.inputs,n=App.getNeededInputs(e,a.score);r.inputs=[],n.forEach(function(t){var n=Object.assign({},t),e=App.getNeededLineItems(n.line_items,a.score);n.line_items=[],e.forEach(function(t){var e=Object.assign({},t);n.line_items.push(e)}),r.inputs.push(n)}),i.actions.push(r)}),e.push(i)}})})}),e},getAllIndicatorTree:function(){var e=[];return App.jeeTree.forEach(function(t){t.capacities.forEach(function(t){t.indicators.forEach(function(t){e.push(t)})})}),e},downloadText:function(t,e){var n="data:application/csv;charset=utf-8,"+escape(e),r=document.createElement("a");r.href=n,r.style="visibility:hidden",r.download=t+".ihr",document.body.appendChild(r),r.click(),document.body.removeChild(r)}};$.tooltipster.setDefaults({contentAsHTML:!0,trigger:"hover",offset:[5,-25],theme:"tooltipster-shadow",maxWidth:320}),$.noty.defaults.type="warning",$.noty.defaults.layout="center",$.noty.defaults.timeout=2e3;var Routing={};!function(){Routing.templates={},Routing.precompileTemplates=function(){$("script[type='text/x-handlebars-template']").each(function(t,e){Routing.templates[e.id.replace("-template","")]=Handlebars.compile($(e).html())})},Routing.initializeRoutes=function(){crossroads.addRoute("/",function(){n("home",App.initHome),window.scrollTo(0,0)}),crossroads.addRoute("/country",function(){n("country",App.initCountry),window.scrollTo(0,0)}),crossroads.addRoute("/overview",function(){n("overview",App.initOverview),window.scrollTo(0,0)}),crossroads.addRoute("/scores",function(){hasher.setHash("scores/p-1/1")}),crossroads.addRoute("/scores/:{ccId}:",function(t){hasher.setHash("scores/"+t+"/1")}),crossroads.addRoute("/scores/:{ccId}:/:{indId}:",function(t,e){void 0===e&&void 0!==t?(e="1",hasher.setHash("scores/"+t+"/"+e)):void 0===e&&void 0===t&&(e="1",t="p-1",hasher.setHash("scores/"+t+"/"+e)),n("scores",App.initScores,t,e)}),crossroads.addRoute("/costsinstructions",function(){n("costs-instructions",App.initCostsInstructions),window.scrollTo(0,0)}),crossroads.addRoute("/costs",function(){hasher.setHash("costs/population")}),crossroads.addRoute("/costs/:{whoTab}:",function(t){n("who",App.initWho,t),window.scrollTo(0,0)}),crossroads.addRoute("/costs/:{ccId}:/:{indId}:",function(t,e){!e&&t?(e="1",hasher.setHash("costs/"+t+"/"+e)):e||t||(e="1",t="p-1",hasher.setHash("costs/"+t+"/"+e)),n("costs",App.initCosting,t,e),window.scrollTo(0,0)}),crossroads.addRoute("/results",function(){n("results",App.initResults),window.scrollTo(0,0)}),crossroads.addRoute("/background/:section:",function(t){n("background",App.initBackground),t?Util.scrollTo(t):window.scrollTo(0,0)}),crossroads.addRoute("/contact",function(){n("contact",App.initContact),window.scrollTo(0,0)}),hasher.prependHash="",hasher.initialized.add(t),hasher.changed.add(t),hasher.init()};var s=["who","costs","results"];function n(t,e){if(!App.whoAmI.abbreviation&&s.includes(t))return hasher.setHash("country"),void noty({timeout:5e3,text:"<b>No country selected!</b><br>Please select a country and complete assessment before entering costs.</b>"});var n,r;n=t,$("#page-content").html(Routing.templates[n](r));for(var a=arguments.length,i=Array(2<a?a-2:0),o=2;o<a;o++)i[o-2]=arguments[o];(function(t){"home"===t&&(t="");d3.selectAll(".nav-item").classed("active",function(){return $(this).attr("page")===t})}).apply(void 0,[t].concat(i)),e&&e.apply(void 0,i)}function t(t){crossroads.parse(t)}}(),NProgress.start(),App.initialize(function(){Routing.precompileTemplates(),Routing.initializeRoutes(),NProgress.done()}),App.buildCapacityDescription=function(t){var e=App.getCapacity(t);d3.selectAll(".capacity-name").text(t.toUpperCase()+" - "+e.name),d3.selectAll(".capacity-target").text(e.target_description),e.desired_impact?d3.selectAll(".capacity-desired-impact").text(e.desired_impact):d3.selectAll(".capacity-desired-impact-container").style("display","none"),e.notes?d3.selectAll(".capacity-additional-notes").text(e.notes):d3.selectAll(".capacity-additional-notes-container").style("display","none"),$(".capacity-description-header").click(function(){$(".capacity-description-details").toggle(),$("#chevron").toggleClass("rotate-chevron")})};var Charts={buildProgressChart:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},r=35,a=45,i=35,o=35,s=n.width||630,c=n.height||36,l=d3.selectAll(t).append("svg").classed("progress-chart",!0).attr("width",s+o+a).attr("height",c+r+i),p=l.append("g").attr("transform","translate("+o+", "+r+")"),u=n.radius||9,d=n.rectHeight||c/2,f=d3.scaleLinear().domain([1,5]).range([0,s]),h=l.append("defs");h.append("filter").attr("id","blur").append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation","1");var m=h.append("pattern").attr("id","diagonalHatch").attr("patternUnits","userSpaceOnUse").attr("width",4).attr("height",4);return m.append("rect").attr("x",-1).attr("y",-1).attr("width",6).attr("height",6).attr("fill","white").attr("stroke","none"),m.append("path").attr("d","M-1,1 l2,-2, M0,4 l4,-4, M3,5 l2,-2").attr("stroke","black").attr("stroke-width",.5),p.selectAll(".color-bar").data([{x0:1,x1:1.5,color:"rgb(200, 33, 39)"},{x0:1.5,x1:3.5,color:"rgb(247, 236, 19)"},{x0:3.5,x1:5,color:"rgb(21, 108, 55)"}]).enter().append("rect").attr("class","color-bar").attr("x",function(t){return f(t.x0)}).attr("width",function(t){return f(t.x1)-f(t.x0)}).attr("height",c).style("fill",function(t){return t.color}).attr("filter","url(#blur)"),p.append("rect").attr("class","base").attr("width",s).attr("height",c),p.append("rect").attr("class","bar bar-0").attr("x",f(1)).attr("y",(c-d)/2).attr("width",f(e[0])-f(1)).attr("height",d).attr("fill","#777"),p.append("rect").attr("class","bar bar-1").attr("x",f(e[0])).attr("y",(c-d)/2).attr("width",f(e[1])-f(e[0])).attr("height",d).attr("fill","url(#diagonalHatch)"),p.append("circle").attr("class","marker marker-0").attr("cx",f(e[0])).attr("cy",c/2).attr("r",u),p.append("circle").attr("class","marker marker-1").attr("cx",f(e[1])).attr("cy",c/2).attr("r",u),p.append("line").attr("class","label-line").attr("x1",f(e[0])).attr("x2",f(e[0])).attr("y1",-10).attr("y2",c/2-u),p.append("text").attr("class","label-text").attr("x",f(e[0])).attr("y",-21).attr("dy",".35em").text("Current Score"),p.append("line").attr("class","label-line").attr("x1",f(e[1])).attr("x2",f(e[1])).attr("y1",c+10).attr("y2",c/2+u),p.append("text").attr("class","label-text").attr("x",f(e[1])).attr("y",c+21).attr("dy",".35em").text("Target Score"),p},buildCostChart:function(t){1<arguments.length&&void 0!==arguments[1]&&arguments[1];var e=70,n=30,r=70,a=100,i=d3.select(t).append("svg").attr("class","cost-chart").attr("width",810+a+n).attr("height",320+e+r),c=i.append("g").attr("transform","translate("+a+", "+e+")");i.append("defs").append("clipPath").attr("id","chart-clip").append("rect").attr("y",-e).attr("width",810+n).attr("height",320+e);var l=d3.scaleBand().range([0,810]),p=d3.scaleLinear().range([320,0]),u=d3.scaleLinear().domain([0,810]).range(["rgb(255, 0, 0)","rgb(0, 66, 118)"]),d=d3.scaleLinear().domain([320,0]).range([5,25]),f=d3.axisBottom(),h=d3.axisLeft().ticks(6).tickSizeInner(-810).tickFormat(function(t){return 0===t?"0":App.siFormat(t)}),m=c.append("g").attr("class","x axis").attr("transform","translate(0, 320)"),g=c.append("g").attr("class","y axis"),v=c.append("g").attr("clip-path","url(#chart-clip)"),o=c.append("text").attr("class","axis-label x-axis-label").attr("x",5).attr("y",380),s=c.append("text").attr("class","axis-label y-axis-label-1").attr("y",-32);return c.append("text").attr("class","axis-label y-axis-label-2").attr("y",-15).text("(in "+App.whoAmI.currency_iso+")"),c.update=function(t,e,n){var r=t||c.currData;t&&(c.currData=t);var a=e||c.currXValFunc;e&&(c.currXValFunc=e);var i=n||c.currYValFunc;n&&(c.currYValFunc=n),l.domain(r.map(a)),p.domain([0,1.1*d3.max(r,i)]),f.scale(l),h.scale(p),m.call(f),g.call(h);var o=l.bandwidth();m.selectAll(".tick text").call(wrap,o),m.selectAll(".tick text").each(function(t){if(!$(this).hasClass("tooltipstered")){var e=App.getCapacity(t);if(e)return void $(this).tooltipster({content:"<b>"+t+"</b> - "+e.name});var n=App.getIndicator(t.toLowerCase());if(n)return void $(this).tooltipster({content:"<b>"+t+"</b> - "+n.name})}}),g.selectAll(".tick text").attr("x",-11);var s=v.selectAll(".indicator-blob").data(r);s.exit().remove(),s.enter().append("circle").attr("class","indicator-blob").each(function(){$(this).tooltipster({maxWidth:400,interactive:!0,content:""})}).merge(s).on("click",function(t){if("indicator"===t.type){var e=App.getCapacity(t.capId),n=[];e.indicators.forEach(function(t){n=n.concat(t.actions)}),c.update(n,function(t){var e=t.id.split(".");return e.pop(),e.join(".").toUpperCase()},i)}}).transition().duration(1200).attr("r",function(t){return d(p(i(t)))}).attr("cx",function(t){return l(a(t))+o/2+o/2*(Math.random()-.5)}).attr("cy",function(t){return p(i(t))}).style("fill",function(t){return u(l(a(t)))}).each(function(t,e){var n=[{name:"Startup Cost",value:t.startupCost},{name:"Capital Cost",value:t.capitalCost},{name:"Recurring Cost",value:t.recurringCost,unit:"/yr"}],r=d3.select(document.createElement("div")),a=r.append("div").attr("class","cc-tooltip");a.append("div").attr("class","cc-tooltip-title").text(Util.capitalize(t.type)+" ("+t.id.toUpperCase()+")"),a.append("div").attr("class","cc-tooltip-subtitle").text(t.name);var i=a.selectAll(".cc-tooltip-block").data(n).enter().append("div").attr("class","cc-tooltip-block");i.append("div").text(function(t){var e=App.moneyFormat(t.value);return t.unit?e+t.unit:e}),i.append("div").text(function(t){return t.name});var o=a.append("div").attr("class","cc-tooltip-button-container").append("button").attr("class","cc-tooltip-button btn btn-secondary").text("Go to Costing");if("indicator"===t.type){var s=t.id.split("."),c="hasher.setHash('costs/"+s.slice(0,s.length-1).join("-")+"/"+s[s.length-1]+"')";o.attr("onClick",c)}else if("action"===t.type){console.log(t);var l=t.id.split("."),p="hasher.setHash('costs/"+l.slice(0,l.length-2).join("-")+"/"+l[l.length-2]+"')";o.attr("onClick",p)}$(this).tooltipster("content",r.html())})},c.updateXAxisLabel=function(t){o.text(t)},c.updateYAxisLabel=function(t){s.text(t)},c},buildBubblePack:function(t,e){for(var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},r={"Coordination / leadership":"#f2f0f7","Planning including assessment, design, planning, policy, legislation":"#dadaeb","Strengthening HR capacity":"#bcbddc","Strengthening infrastructure":"#9e9ac8","Operations / implementation":"#807dba","Analysis including data quality and dissemination":"#6a51a3","Use and review mechanisms":"#4a1486"},a=60,i=30,o=60,s=95,c=d3.select(t).append("svg").attr("class","bubble-chart").attr("width",580+s+i).attr("height",300+a+o).append("g").attr("class","bubble-pack").attr("transform","translate("+s+", "+a+")"),l=[],p=0;p<Object.keys(e).length;p++){var u={},d=Object.keys(e)[p];u.name=d,"total"===n.costType&&(u.value=e[d]["start-up"]+e[d].recurring*n.totalCostDuration+e[d].capital),l.push(u)}e=l;var f=c,h=d3.format(",d"),m=(d3.scaleOrdinal(d3.schemeCategory20),d3.pack().size([580,300]).padding(1.5)),g=d3.forceCollide(function(t){return t.r+1}),v=d3.forceSimulation().force("charge",d3.forceManyBody()).force("collide",g).force("x",d3.forceX(290).strength(.05)).force("y",d3.forceY(150).strength(.05)),b=d3.hierarchy({children:e}).sum(function(t){return t.value}),A=m(b).leaves().map(function(t){var e=t.data;return{x:290+3*(t.x-290),y:150+3*(t.y-150),r:0,radius:t.r+5,id:e.cat,cat:e.cat,name:e.name,value:e.value,icon:e.icon,desc:e.desc}});v.nodes(A).on("tick",function(){y.attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).select("circle").attr("r",function(t){return t.r})}),f.style("background-color","#eee");var y=f.selectAll(".node").data(A).enter().append("g").attr("class","node").call(d3.drag().on("start",function(t){d3.event.active||v.alphaTarget(.2).restart(),t.fx=t.x,t.fy=t.y}).on("drag",function(t){t.fx=d3.event.x,t.fy=d3.event.y}).on("end",function(t){d3.event.active||v.alphaTarget(0),t.fx=null,t.fy=null}));y.append("circle").attr("id",function(t){return t.id}).attr("r",0).attr("class","bubble").attr("stroke-width","1px").transition().duration(2e3).ease(d3.easeElasticOut).tween("circleIn",function(e){var n=d3.interpolateNumber(0,e.radius);return function(t){e.r=n(t),v.force("collide",g)}}),y.append("clipPath").attr("id",function(t){return"clip-"+t.id}).append("use").attr("xlink:href",function(t){return"#"+t.id}),y.append("title").text(function(t){return t.name+"\n"+h(t.value)}),y.on("mouseover",function(t){d3.select(this).select("circle").attr("stroke-width","3px").attr("stroke","black")}),y.on("mouseout",function(t){d3.select(this).select("circle").attr("stroke",function(t){return d3.color(r[t.name]).darker().toString()}).attr("stroke-width","1px")})}},Colors={jeeRed:"#C12025",jeeYellow:"#EDE929",jeeGreen:"#87C764"};Colors.scoreColors={1:Colors.jeeRed,2:Colors.jeeYellow,3:Colors.jeeYellow,4:Colors.jeeGreen,5:Colors.jeeGreen,"":"#bbb"},App.definitions={totalCost:"The <b>total cost</b>, depending on the duration selected, is the sum of the startup cost, capital cost, and recurring costs.",startupCost:"<b>Startup costs</b> are one-time expenses incurred in the first year, excluding construction and durable equipment costs.",capitalCost:"<b>Capital costs</b> are non-recurring costs incurred in the first year for construction and durable equipment.",recurringCost:"<b>Recurring costs</b> are annual operating expenses, including salaries."},App.getSessionData=function(){var e={},n={};return App.jeeTree.forEach(function(t){t.capacities.forEach(function(t){t.indicators.forEach(function(t){e[t.id]=t.score||0,t.actions.forEach(function(t){t.inputs.forEach(function(t){var e={costed:t.costed,isCustomCost:t.isCustomCost};t.isCustomCost&&(e.customStartupCost=t.customStartupCost,e.customRecurringCost=t.customRecurringCost),n[t.id]=e})})})})}),JSON.stringify({whoAmI:App.whoAmI,scoreData:e,costData:n,user:User})},App.loadSessionData=function(t){var e=void 0;try{e=JSON.parse(t)}catch(t){return!1}for(var n in e.user)User[n]=e.user[n];App.whoAmI=e.whoAmI;var r=e.scoreData,a=e.costData;return App.jeeTree.forEach(function(t){t.capacities.forEach(function(t){t.indicators.forEach(function(t){r[t.id]&&(t.score=r[t.id]),t.actions.forEach(function(t){t.inputs.forEach(function(t){if(a[t.id])for(var e in a[t.id])t[e]=a[t.id][e]})})})})}),!0},App.loadQlickScoreData=function(t){var e=void 0;try{e=XLSX.read(t,{type:"binary"})}catch(t){return!1}var n=e.SheetNames[0],r=e.Sheets[n];return r.A1.w="country_name",r.B1.w="capacity_name",r.C1.w="indicator_name",r.D1.w="score",XLSX.utils.sheet_to_json(r,{defval:""}).forEach(function(t){var e=t.indicator_name.split(" ")[0].toLowerCase();if(""!==e){var n=+t.score;!isNaN(n)&&1<=n&&n<=5&&App.setIndicatorScore(e,n)}}),!0},App.exportLineItems=function(l){var t=App.getCompleteIndicatorTree(),e=new XMLHttpRequest;e.open("POST","/lineItemExport",!0),e.responseType="blob",e.setRequestHeader("Content-type","application/json"),e.onload=function(t){if(200==this.status){var e=new Blob([this.response],{type:"application/vnd.ms-excel"}),n=URL.createObjectURL(e),r=document.createElement("a");r.href=n;var a=new Date,i=a.getFullYear(),o=String(a.getMonth()+1);1===o.length&&(o="0"+o);var s=String(a.getDate());1===s.length&&(s="0"+s);var c=""+i+o+s+" "+App.whoAmI.abbreviation;return r.download="IHR Costing Tool - Detailed Report - "+c+".xlsx",document.body.appendChild(r),r.click(),void(l&&l(null))}l&&l(this.status)},App.whoAmI.staff_overhead_perc_str=Util.percentizeDec(App.whoAmI.staff_overhead_perc),e.send(JSON.stringify({exportType:"userData",indicators:t,currencyCode:App.whoAmI.currency_iso,exchangeRate:App.getExchangeRate(),whoAmI:App.whoAmI,gbc:App.globalBaseCosts,gsm:App.globalStaffMultipliers,User:User}))},App.exportCostingWorksheet=function(p){var t=App.getAllIndicatorTree(),e=App.getScoredIndicatorTree(),n=new XMLHttpRequest;n.open("POST","/lineItemExport",!0),n.responseType="blob",n.setRequestHeader("Content-type","application/json"),n.onload=function(t){if(200==this.status){var e=new Blob([this.response],{type:"application/vnd.ms-excel"}),n=URL.createObjectURL(e),r=document.createElement("a");r.href=n;var a=new Date,i=a.getFullYear(),o=String(a.getMonth()+1);1===o.length&&(o="0"+o);var s=String(a.getDate());1===s.length&&(s="0"+s);var c=""+i+o+s,l=(App.whoAmI.abbreviation,c);return r.download="IHR Costing Tool - Costing Worksheet - "+l+".xlsx",document.body.appendChild(r),r.click(),void(p&&p(null))}p&&p(this.status)},App.whoAmI.staff_overhead_perc_str=Util.percentizeDec(App.whoAmI.staff_overhead_perc),t.forEach(function(t){delete t.score_descriptions,t.actions.forEach(function(t){t.inputs.forEach(function(t){t.line_items.forEach(function(t){delete t.category_tag,delete t.function_tag,delete t.where_find_base_cost,delete t.references,delete t.unique_id})})})}),e.forEach(function(t){delete t.score_descriptions,t.actions.forEach(function(t){t.inputs.forEach(function(t){t.line_items.forEach(function(t){delete t.category_tag,delete t.function_tag,delete t.where_find_base_cost,delete t.references,delete t.unique_id})})})}),n.send(JSON.stringify({exportType:"costingWorksheet",indicators:t,userRelevantInd:e,currencyCode:App.whoAmI.currency_iso,exchangeRate:App.getExchangeRate(),whoAmI:App.whoAmI,gbc:App.globalBaseCosts,gsm:App.globalStaffMultipliers,User:User}))},App.geoJson={},App.createLeafletMap=function(){App.mapConfig={divId:"leaflet-map",view:{coordinates:[20,0],zoom:2},url:"https://api.mapbox.com/styles/v1/jpecht/cj6qlfi5m3lg62rmz8svshi43/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoianBlY2h0IiwiYSI6ImNpdHhlMTc5NzAwczEydHFtbnZnankzNmEifQ.79pr8-kMwzRaEzUhvvgzsw",options:{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',maxZoom:8,minZoom:2,id:"mapbox.light",accessToken:"pk.eyJ1Ijoibmljb2xhaXZhc3F1ZXoiLCJhIjoiY2o2MWNlaWk3MG5ycTJ3bndmZWs4NWFyNSJ9.h0XBCKm965_UoB4oRS_3eA"},styles:{default:{stroke:!0,weight:0,fill:!0,color:"transparent"},active:{fillColor:"#ff7a7a"},selected:{fillColor:"#dd0000",weight:1,color:"#333"}}};var e=void 0,n=void 0,r="",a=function(t){var e=t.target;r!==e.feature.properties.iso_a2&&e.setStyle(App.mapConfig.styles.active)},i=function(t){t.target,r!==t.target.feature.properties.iso_a2&&(App.geoJson.resetStyle(t.target),n.update())},o=function(t){var e=t.target.feature.properties.iso_a2;if(e===r)return r="",App.geoJson.resetStyle(t.target),void(App.whoAmI={});r=e,App.geoJson.eachLayer(function(t){e===t.feature.properties.iso_a2?t.setStyle(App.mapConfig.styles.selected):App.geoJson.resetStyle(t)}),App.updateCountry(e)},s=function(t,e){e.on({mouseover:a,mouseout:i,click:o}),App.whoAmI.hasOwnProperty("abbreviation")&&App.whoAmI.abbreviation===e.feature.properties.iso_a2&&(e.setStyle(App.mapConfig.styles.selected),r=App.whoAmI.abbreviation)};return setTimeout(function(){e=L.map(App.mapConfig.divId,{zoomSnap:.1}).setView(App.mapConfig.view.coordinates,App.mapConfig.view.zoom),L.tileLayer(App.mapConfig.url,App.mapConfig.options).addTo(e),(n=L.control({position:"topright"}).setPosition("topright")).onAdd=function(t){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},n.update=function(t){this._div.innerHTML=t&&t.name?"<p>"+t.name+"</p>":""},$.getJSON("data/custom.geo.json",function(t){App.geoJson=L.geoJson(t,{style:App.mapConfig.styles.default,onEachFeature:s}).addTo(e)}),n.addTo(e),n.setPosition("topright")},100),e},App.buildTabNavigation=function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},r=e.split(".")[0],a=d3.select(t).selectAll(".block-link-capacities").data(App.jeeTree).enter().append("div").attr("class","block-link-capacities"),i=a.append("div").attr("class","block-link-capabilities-header").classed("active",function(t){return"Other"===t.name?t.active=!App.normalCcIds.includes(r):t.active=t.id===r}).on("click",function(t){var e=hasher.getHashAsArray(),n=t.capacities[0].id.replace(".","-");hasher.setHash(e[0]+"/"+n+"/1")});i.append("div").attr("class","block-link-cover"),i.append("svg").attr("class","chevron").attr("viewBox","0 0 24 24").classed("active",function(t){return t.active}).attr("src","img/chevron-right.png").append("path").attr("d","M8 5v14l11-7z"),i.append("span").text(function(t){return t.name});var o=a.append("div").style("display",function(t){return t.active?"block":"none"}).selectAll(".block-link").data(function(t){return t.capacities}).enter().append("div").attr("class","block-link").classed("active",function(t){return t.id===e}).on("click",function(t){var e=hasher.getHashAsArray(),n=t.id.replace(".","-");hasher.setHash(e[0]+"/"+n+"/1")});o.append("div").attr("class","block-link-title").html(function(t){return t.id.toUpperCase()+" - "+t.name}),o.append("div").attr("class","block-link-subtitle").classed("active",function(t){return t.id===e}).html(function(t){return n.displayCostingProgress?App.getNumIndicatorsCosted(t)+" of "+t.indicators.length:t.indicators.filter(function(t){return t.score}).length+" of "+t.indicators.length}),o.append("div").attr("class","block-link-cover")},App.initBackground=function(){},App.initContact=function(){},App.initCosting=function(b,A){var a=Util.getIndicatorId(b),y=Util.getIndicatorId(b+"-"+A),C=App.getCapacity(a),x=App.getIndicator(y),w=App.getNeededActions(x);function k(e){d3.selectAll(".action-slot-container, .action-slot").classed("active",function(t){return t.id===e.id}).select(".chevron").classed("active",function(t){return t.id===e.id});var t="340px";$(".action-slot-container:not(.active) .item-block-container").css("height",t).css("min-height","0px").slideUp(400,function(){$(this).css("height","auto").css("min-height",t)}),$(".action-slot-container.active .item-block-container").css("height",t).css("min-height","0px").slideDown(400,function(){$(this).css("height","auto").css("min-height",t)}),w.length?$(".action-description").html(e.id.toUpperCase()+" - "+e.name):$(".action-description").html("<i>No actions need to be taken to increase the score for this indicator</i>")}function _(){d3.selectAll(".action-progress").text(function(t){var e=App.getNeededInputs(t.inputs,x.score);return e.filter(function(t){return t.costed}).length+" of "+e.length+" items costed"})}$(".go-to-results-button").click(function(){return hasher.setHash("results")}),App.buildTabNavigation(".block-link-container",a,{displayCostingProgress:!0}),$(".capacity-description-container").html(Routing.templates["capacity-description"]()),App.buildCapacityDescription(a),"Immunization"===C.name&&$(".capacity-tooltip-img").show().tooltipster({interactive:!0,content:'An alternative method to estimate vaccination costs is available using the <a href="http://www.avenirhealth.org/software-onehealth.php" target="_blank">OneHealth Tool</a>'}),function(){var t,e;t=C.indicators.length,e=App.getNumIndicatorsCosted(C),d3.select(".indicator-progress").text("Review costs for each indicator ("+e+" of "+t+"):");var n=d3.select(".indicator-container").selectAll(".indicator-slot-container").data(C.indicators).enter().append("div").attr("class","indicator-slot-container"),r=n.append("div").attr("class","indicator-slot").classed("active",function(t){return t.id===y}).classed("empty",function(t){return void 0===App.getIndicatorScore(t.id)}).on("click",function(t,e){hasher.setHash("costs/"+b+"/"+(e+1))});r.append("svg").attr("class","chevron").classed("active",function(t){return t.id===y}).attr("viewBox","0 0 24 24").append("path").attr("d","M8 5v14l11-7z"),r.append("div").attr("class","indicator-id").text(function(t){return t.id.toUpperCase()+" - "}),r.append("div").attr("class","indicator-name").text(function(t){return Util.truncateText(t.name)}),r.append("div").attr("class","indicator-score").html(function(t){var e=App.getIndicatorScore(t.id);if(!e)return"<i>No Score</i>";var n="step"===User.targetScoreType?e+1:User.targetScore,r='<img class="rp-score" src="img/rp-'+e+'.png" alt='+e+" />";return e<n&&e<4&&(r+='<span> to </span><img class="rp-score" src="img/rp-'+n+'.png" alt='+n+" />"),r}),$(".indicator-description").html(y.toUpperCase()+" - "+x.name);var a=n.filter(function(t){return t.id===y});if(!x.score)return a.append("div").attr("class","no-score-container").html("This indicator has not been <b>scored</b> yet. Click <u>here</u> to enter a score.").on("click",function(){hasher.setHash("scores/"+b+"/"+A)}),$(".action-description-container").hide();if(!w.length){var i="There are no actions needed to increase the current score for this indicator";return 4===x.score?i="Costs to increase from score <b>4</b> to <b>5</b> are highly country-specific and are not included in the IHR Costing Tool.":5===x.score&&(i="Indicators with a score of <b>5</b> do not require costing (no new actions required)."),a.append("div").attr("class","no-actions-container").html(i),$(".action-description-container").hide()}var o=a.selectAll(".action-slot").data(w).enter().append("div").attr("class","action-slot-container"),s=o.append("div").attr("class","action-slot").attr("action-id",function(t){return t.id}).on("click",function(t){return k(t)});s.append("svg").attr("class","chevron").attr("viewBox","0 0 24 24").append("path").attr("d","M8 5v14l11-7z"),s.append("div").attr("class","action-name").text(function(t){return t.id.toUpperCase()+" - "+t.name}),s.append("div").attr("class","action-progress"),_();var c="155px",l=o.append("div").attr("class","item-block-container").each(function(t){return t.itemShownIndex=0});l.append("div").attr("class","item-block-progress-text").text(function(t){return"Item 1 of "+App.getNeededInputs(t.inputs,x.score).length}),l.append("div").attr("class","item-block-arrow-prev item-block-arrow").style("display","none").on("click",function(t){var e=$(this).parent();e.find(".item-block[item-index="+t.itemShownIndex+"]").animate({left:"800px"}),t.itemShownIndex--,e.find(".item-block[item-index="+t.itemShownIndex+"]").animate({left:c});var n=App.getNeededInputs(t.inputs,x.score).length;e.find(".item-block-progress-text").text("Item "+(t.itemShownIndex+1)+" of "+n),0===t.itemShownIndex&&$(this).hide(),e.find(".item-block-arrow-next").show()}).append("img").attr("src","img/prev-arrow.png").attr("alt","Previous"),l.append("div").attr("class","item-block-arrow-next item-block-arrow").style("display",function(t){return 1<App.getNeededInputs(t.inputs,x.score).length?"block":"none"}).on("click",function(t){var e=$(this).parent();e.find(".item-block[item-index="+t.itemShownIndex+"]").animate({left:"-800px"}),t.itemShownIndex++,e.find(".item-block[item-index="+t.itemShownIndex+"]").animate({left:c});var n=App.getNeededInputs(t.inputs,x.score).length;e.find(".item-block-progress-text").text("Item "+(t.itemShownIndex+1)+" of "+n),t.itemShownIndex+1>=n&&$(this).hide(),e.find(".item-block-arrow-prev").show()}).append("img").attr("src","img/next-arrow.png").attr("alt","Next");var p=l.selectAll(".item-block").data(function(t){return App.getNeededInputs(t.inputs,x.score)}).enter().append("div").attr("class","item-block").attr("item-index",function(t,e){return e}).style("left",function(t,e){return 0===e?c:"800px"}).append("div").attr("class","item-shell"),u=p.append("div").attr("class","front").append("div").attr("class","item-front-shell"),d=p.append("div").attr("class","back");u.append("div").attr("class","item-title-container").append("div").attr("class","item-title").text(function(t){return t.name});var f=u.append("div").attr("class","item-startup-cost-container");f.append("div").attr("class","item-cost-name").text("Startup Cost: "),f.append("input").attr("class","startup-cost-input form-control").attr("value",function(t){var e=t.isCustomCost?t.customStartupCost:t.startupCost+t.capitalCost;return Util.comma(e)}).style("color",function(t){return t.costed?"black":"#999"}).on("change",function(t){t.isCustomCost=!0,t.customStartupCost=Util.getInputNumVal(this),t.customRecurringCost||(t.customRecurringCost=t.recurringCost),t.costed=!0;var e=$(this).closest(".item-block");e.find("input").css("color","black"),e.find(".item-save-button").removeClass("primary"),App.updateAllCosts()}),f.append("div").attr("class","item-cost-currency").text(App.whoAmI.currency_iso),f.append("img").attr("class","item-cost-tooltip-img").attr("src","img/question-mark.png").each(function(t){$(this).tooltipster({content:App.definitions.startupCost})});var h=u.append("div").attr("class","item-recurring-cost-container");h.append("div").attr("class","item-cost-name").text("Recurring Cost: "),h.append("input").attr("class","recurring-cost-input form-control").attr("value",function(t){var e=t.isCustomCost?t.customRecurringCost:t.recurringCost;return Util.comma(e)}).style("color",function(t){return t.costed?"black":"#999"}).on("change",function(t){t.isCustomCost=!0,t.customRecurringCost=Util.getInputNumVal(this),t.customStartupCost||(t.customStartupCost=t.startupCost+t.capitalCost),t.costed=!0;var e=$(this).closest(".item-block");e.find("input").css("color","black"),e.find(".item-save-button").removeClass("primary"),App.updateAllCosts()}),h.append("div").attr("class","item-cost-currency").text(App.whoAmI.currency_iso+"/yr"),h.append("img").attr("class","item-cost-tooltip-img").attr("src","img/question-mark.png").each(function(t){$(this).tooltipster({content:App.definitions.recurringCost})}),u.append("div").attr("class","item-save-cost-text").text("Costs Saved!");var m=u.append("div").attr("class","item-footer");m.append("div").attr("class","item-save-button").classed("primary",function(t){return!t.costed}).text("Save Costs").on("click",function(t){if(!t.costed){t.costed=!0,$(this).removeClass("primary").closest(".item-block").find("input").css("color","black"),_();var e=App.getNumIndicatorsCosted(C);d3.select(".block-link-subtitle.active").text(e+" of "+C.indicators.length)}var n=$(this).closest(".item-block").find(".item-save-cost-text");n.show(),setTimeout(function(){n.fadeOut(800)},1e3),App.updateAllCosts()}),m.append("div").attr("class","item-view-details-button").text("View Details").on("click",function(){$(this).closest(".item-block").toggleClass("active")});var g=d.append("div").attr("class","item-details-container");function v(t,r){var e=g.append("div").style("display",function(t){var e=App.getNeededLineItems(t.line_items,x.score),n=e.filter(r);return n.length?"block":"none"});e.append("div").attr("class","item-details-title").text(t);var n=e.append("div").attr("class","line-item-table-container"),a=n.append("table").attr("class","line-item-table table table-condensed table-striped").append("tbody"),i=a.selectAll("tr").data(function(t){var e=App.getNeededLineItems(t.line_items,x.score);return e.filter(r)}).enter().append("tr"),o=i.append("td");o.append("span").text(function(t){return t.name}),o.append("img").attr("class","line-item-description-button").attr("src","img/question-mark.png").each(function(t){var e='<div class="li-tooltip-content">';e+="<b>"+t.name+":</b> "+t.description,e+="</div>",$(this).tooltipster({interactive:!0,trigger:"click",content:e})}),i.append("td").text(function(t){return App.moneyFormatLong(t.cost)});var s=a.append("tr");return s.append("td").text("Total"),s.append("td").text(function(t){var e=App.getNeededLineItems(t.line_items,x.score),n=e.filter(r);return App.moneyFormatLong(d3.sum(n,function(t){return t.cost}))}),e}v("Default Startup/Capital Costs",function(t){return"start-up"===t.line_item_type||"capital"===t.line_item_type}),v("Default Recurring Costs",function(t){return"recurring"===t.line_item_type}),d3.selectAll(".item-details-container").each(function(t){var e=App.getNeededLineItems(t.line_items,x.score),n=e.filter(function(t){return"recurring"===t.line_item_type});n.length&&n.length<e.length&&d3.select(this).selectAll(".line-item-table-container").style("height","57px")}),g.append("div").attr("class","item-footer").append("div").attr("class","item-return-to-front-button").text("Return to Edit Cost").on("click",function(){$(this).closest(".item-block").toggleClass("active")})}(),w.length&&k(w[0]),d3.select(".next-cost").on("click",function(){var t=App.getNextIndicator(a,y).id;t||hasher.setHash("results");var e=t.lastIndexOf("."),n=t.slice(0,e).replace(".","-"),r=t.slice(e+1);hasher.setHash("costs/"+n+"/"+r)}),d3.select(".previous-cost").on("click",function(){var t=App.getPrevIndicator(a,y).id;if(t){var e=t.lastIndexOf("."),n=t.slice(0,e).replace(".","-"),r=t.slice(e+1);hasher.setHash("costs/"+n+"/"+r)}})},App.initCostsInstructions=function(){$(".target-score-option").click(function(){d3.selectAll(".target-score-option input").property("checked",!1),d3.select(this).select("input").property("checked",!0);var t=d3.select(this).attr("ind");if("target"===(User.targetScoreType=t)){var e=$(this).find("select").val();User.targetScore=e}App.updateAllCosts()}),$(".target-score-select").on("change",function(){var t=$(this).val();User.targetScore=t,App.updateAllCosts(),4==+t?$(".color-bar").css("background-color","#87c764"):$(".color-bar").css("background-color","#ede929")}),$(".btn-blank-template").on("click",function(){App.exportCostingWorksheet()}),$(".costs-instructions-start").click(function(){hasher.setHash("costs")})},App.initCountry=function(){App.createLeafletMap();var t=App.countryParams.slice(0);Util.sortByKey(t,"name"),t.unshift({name:"--- choose a country ---",abbreviation:""}),Util.populateSelect(".country-dropdown",t,{nameKey:"name",valKey:"abbreviation"}),$(".country-dropdown").on("change",function(){App.updateCountry($(this).val())}),App.whoAmI.abbreviation&&$(".country-dropdown").val(App.whoAmI.abbreviation);var n=void 0,a=$(".live-search-results-container");function r(t){if(""!==t.trim()){var e=new Fuse(App.countryParams,{threshold:.3,distance:1e5,keys:["abbreviation","name","currency_iso"]}).search(t);if(a.show(),0===e.length)a.find(".live-search-no-results-text").show(),a.find(".live-search-results-contents").hide();else{a.find(".live-search-no-results-text").hide(),a.find(".live-search-results-contents").show();var n=d3.select(a[0]).select(".live-search-results-contents").selectAll(".live-search-results-box").data(e.slice(0,4));n.exit().remove();var r=n.enter().append("div").attr("class","live-search-results-box");r.append("div").attr("class","live-search-results-title"),r.append("div").attr("class","live-search-results-subtitle"),(n=n.merge(r).attr("code",function(t){return t.abbreviation}).on("mousedown",function(t){$(".country-search-input").val(""),App.updateCountry(t.abbreviation)})).select(".live-search-results-title").text(function(t){return t.name}),n.select(".live-search-results-subtitle").text(function(t){return"Population: "+Util.comma(t.multipliers.population)})}}else a.hide()}$(".country-search-input").on("focus",function(){r($(this).val())}).on("blur",function(){clearTimeout(n),a.hide()}).on("keyup",function(t){clearTimeout(n);var e=$(this).val();13===t.which?r(e):n=setTimeout(function(){r(e)},250)}),App.updateCountry=function(e){var n;$(".country-dropdown").val(e),n=e,App.geoJson.eachLayer(function(t){t.feature.properties.iso_a2===n?t.setStyle(App.mapConfig.styles.selected):App.geoJson.resetStyle(t)});var t=App.countryParams.find(function(t){return t.abbreviation===e});App.whoAmI=JSON.parse(JSON.stringify(t)),App.updateAllCosts()},$(".go-to-assessment-button").click(function(){return hasher.setHash("overview")})},App.initHome=function(){$(".enter-site").click(function(){return hasher.setHash("country")})},App.initOverview=function(){$(".next-button").click(function(){hasher.setHash("scores/")}),$(".jee-tool-img").tooltipster({trigger:"hover",content:"The <b>JEE Technology Tool</b> is a separate, open-access tool developed by the Global Health Security Agenda Private Sector Roundtable Technology and Analytics Working Group and powered by Qlik Technologies."}),$(".btn-prior-session").on("click",function(){$(".input-prior-session").trigger("click")}),$(".input-prior-session").on("change",function(){if("files"in this){if(!this.files.length)return;var t=this.files[0];if(".ihr"!==t.name.slice(t.name.length-4))return void noty({timeout:5e3,text:"<b>Please select a file with a file type extension of <i>.ihr</i>"});var e=new FileReader;e.onload=function(t){NProgress.start(),App.loadSessionData(t.target.result)?(App.updateAllCosts(),noty({timeout:4e3,type:"success",text:"<b>Upload Successful!</b><br>Your previous session has been restored."})):noty({timeout:5e3,text:"<b>Error!</b><br>There was an error uploading your previous session."}),NProgress.done()},e.readAsBinaryString(t)}}),$(".btn-blank-template").on("click",function(){NProgress.start(),App.exportCostingWorksheet(function(){NProgress.done()})}),$(".btn-score-file").on("click",function(){$(".input-score-file").trigger("click")}),$(".input-score-file").on("change",function(){if("files"in this){if(!this.files.length)return;var t=this.files[0],e=t.name.split("."),n=e[e.length-1];if("xlsx"!==n&&"xls"!==n)return void noty({timeout:5e3,text:"<b>Please select a file with a file type extension of <i>.xlsx</i>"});var r=new FileReader;r.onload=function(t){NProgress.start(),App.loadQlickScoreData(t.target.result)?(App.updateAllCosts(),noty({timeout:4e3,type:"success",text:"<b>Upload Successful!</b><br>Score data has been uploaded."})):noty({timeout:5e3,text:"<b>Error!</b><br>There was an error uploading the score data. Please check the file format."}),NProgress.done()},r.readAsBinaryString(t)}})},App.initResults=function(){var t,e="capacity",n="total",r=1,o=[],a=[],s=[],d=[],f=[],h=[],m={};if(App.jeeTree.forEach(function(p){var u=!1;p.capacities.forEach(function(c){var l=!1;c.indicators.forEach(function(t){if(App.isIndicatorComplete(t)){l=u=!0;var i=Object.assign({},t);i.ccId=p.id,i.capId=c.id,d.push(i),i.costByTag={};var e=App.getNeededActions(i);for(var n in e.forEach(function(t){f.push(Object.assign({},t)),App.getNeededInputs(t.inputs,i.score).forEach(function(t){var n={},e=App.getNeededLineItems(t.line_items,i.score),r=d3.sum(e,function(t){return t.cost});for(var a in e.forEach(function(t){var e=t.function_tag;n[e]||(n[e]=0),n[e]+=r?t.cost/r:1}),n)i.costByTag[a]||(i.costByTag[a]={startupCost:0,capitalCost:0,recurringCost:0}),t.isCustomCost?(i.costByTag[a].startupCost+=Math.round(n[a]*t.customStartupCost),i.costByTag[a].recurringCost+=Math.round(n[a]*t.customRecurringCost)):(i.costByTag[a].startupCost+=Math.round(n[a]*t.startupCost),i.costByTag[a].capitalCost+=Math.round(n[a]*t.capitalCost),i.costByTag[a].recurringCost+=Math.round(n[a]*t.recurringCost))})}),i.costByTag)if(n){var r=Object.assign({},i),a=i.costByTag[n];for(var o in 0===n.indexOf("Planning")||0===n.indexOf("Analysis")?r.category_tag=n.split(" ")[0]:r.category_tag=n,a)r[o]=a[o];for(var s in h.push(r),m[n]||(m[n]={startupCost:0,capitalCost:0,recurringCost:0}),a)m[n][s]+=a[s]}}}),l&&s.push(c)}),u&&a.push(p)}),!a.length)return $(".results-content").hide(),void $(".results-empty-content").on("click",function(){return hasher.setHash("scores/p-1/1")}).show();function i(){return"total"===n?function(t){return t.startupCost+t.capitalCost+r*t.recurringCost}:"startup"===n?function(t){return t.startupCost}:"capital"===n?function(t){return t.capitalCost}:"recurring"===n?function(t){return t.recurringCost}:function(t){return 0}}function c(t){return i()(t)}function l(){var r,a,t;C.update((r=[],a=$(".category-select").val(),"capacity"===e?d.forEach(function(e){var t=Object.assign({},e),n=h.filter(function(t){return t.id===e.id&&a.includes(t.category_tag)});t.startupCost=d3.sum(n,function(t){return t.startupCost}),t.capitalCost=d3.sum(n,function(t){return t.capitalCost}),t.recurringCost=d3.sum(n,function(t){return t.recurringCost}),r.push(t)}):"category"===e&&(r=(r=h).filter(function(t){return a.includes(t.category_tag)})),r.filter(function(t){return o.includes(t.capId)})),"capacity"===e?function(t){return t.capId.toUpperCase()}:"category"===e?function(t){return t.category_tag}:function(t){return 0},i()),t="","capacity"===e?t="Capacity":"category"===e&&(t="Function"),C.updateXAxisLabel(t),p()}function p(){var t="";t="total"===n?r+"-Year":n.charAt(0).toUpperCase()+n.slice(1),C.updateYAxisLabel(t+" Cost")}t=_.unique(h.map(function(t){return t.category_tag})),$(".num-costed-indicators").text(d.length),$(".num-costed-capacities").text(s.length),$(".view-table-button").on("click",function(){var t=$(this);t.toggleClass("table-view");var e=t.hasClass("table-view");t.text(e?"View Charts":"View Data Table"),$(".results-main-content, .results-table-content").slideToggle()}),$(".view-export-button").on("click",function(){var t=$(this);if(t.toggleClass("export-view"),t.hasClass("export-view"))$(".results-instructions, .results-main-content, .results-table-content").slideUp(),$(".view-table-button").hide(),t.html("&laquo; Back to Results");else{var e=$(".view-table-button").hasClass("table-view");$(".results-instructions").slideDown(),e?$(".results-table-content").slideDown():$(".results-main-content").slideDown(),$(".view-table-button").show(),t.html("Export Data")}}),$(".cost-type-row button").each(function(){var t=$(this).attr("value");$(this).tooltipster({content:App.definitions[t+"Cost"]})}).on("click",function(){n=$(this).attr("value"),$('.cost-type-row button[value="'+n+'"]').addClass("active").siblings().removeClass("active"),"total"===n?$(".cost-duration-row").slideDown():$(".cost-duration-row").slideUp(),A(),p(),C.update(null,null,i())}),$(".cost-duration-row button").on("click",function(){r=+$(this).attr("value"),$('.cost-duration-row button[value="'+r+'"]').addClass("active").siblings().removeClass("active"),A(),p(),C.update(null,null,i())}),$(".view-cost-by-box .filter-row").on("click",function(){var t=$(this);t.find("input").prop("checked",!0),t.siblings(".filter-row").find("input").prop("checked",!1),e=t.attr("value"),l()}),$(".reset-button").on("click",function(){l()});var u=App.getAverageCurrentScore(d),g=App.getAverageTargetScore(d);Charts.buildProgressChart(".progress-chart-overall",[u,g]);var v=d3.select(".summary-text-section").selectAll(".summary-text-box").data(App.jeeTree).enter().append("div").attr("class","summary-text-box").each(function(e){e.isEmpty=!a.find(function(t){return t.name===e.name}),e.isEmpty&&$(this).tooltipster({interactive:!0,content:"There are <b>no scored/costed indicators</b> for this core element. Click <span onclick=\"hasher.setHash('scores/"+e.id+"-1/1')\">here</span> to go to the scoring page for this core element."})}).on("click",function(t){t.isEmpty||function(t){o=t.capacities.map(function(t){return t.id}),x(),l();var e=$(".chart-section").position().top+110;$("html, body").animate({scrollTop:e},600)}(t)});v.append("div").attr("class",function(t){if(!t.isEmpty){var e=[];t.capacities.forEach(function(t){e=e.concat(t.indicators)});var n=App.getAverageTargetScore(e),r="green";return n<2?r="red":n<4&&(r="yellow"),"summary-text-box-veil "+r}return"summary-text-box-veil"});var b=v.append("div").attr("class","summary-text-box-content");function A(){y(".total-cost-number",d3.sum(App.jeeTree,function(t){return c(t)})),d3.selectAll(".summary-text-box .big-number").each(function(e){a.find(function(t){return t.name===e.name})?y(this,c(e)):d3.select(this).text("-")})}function y(t,r){var e=d3.select(t);isNaN(Util.strToFloat(e.text()))&&e.text(App.moneyFormat(1e6)),e.transition().duration(300).tween("text",function(t){var e=d3.select(this),n=d3.interpolateNumber(Util.strToFloat(e.text()),r);return function(t){return e.text(App.moneyFormat(n(t)))}})}b.append("div").attr("class","big-number-text").html(function(t){return t.name+" Cost"}),b.append("div").attr("class","big-number"),d3.select(".total-cost-number").text(App.moneyFormat(1e6));var C=Charts.buildCostChart(".cost-chart-container");function x(){var a=[],i=[];App.jeeTree.forEach(function(t){for(var e=!1,n=t.capacities.map(function(t){return t.id}),r=0;r<o.length;r++)if(n.includes(o[r])){e=!0,a.push(t.id);break}e||i.push(t.id)}),$(".cc-select").multiselect("select",a,!1).multiselect("deselect",i,!1);var t=s.filter(function(t){return!o.includes(t.id)}).map(function(t){return t.id});$(".capacity-select").multiselect("select",o,!1).multiselect("deselect",t,!1)}Util.populateSelect(".cc-select",App.jeeTree,{nameKey:"name",valKey:"id",selected:!0}),Util.populateSelect(".capacity-select",s,{nameKey:function(t){return t.id.toUpperCase()+" - "+t.name},valKey:"id",selected:!0}),Util.populateSelect(".category-select",t,{selected:!0}),$(".cc-select").multiselect({includeSelectAllOption:!0,numberDisplayed:1,buttonClass:"btn btn-secondary",onChange:function(e,t){var n=App.jeeTree.find(function(t){return t.id===e.val()}).capacities.map(function(t){return t.id});t?n.forEach(function(t){o.includes(t)||o.push(t)}):o=o.filter(function(t){return!n.includes(t)}),x(),l()},onSelectAll:function(){o=s.map(function(t){return t.id}),x(),l()},onDeselectAll:function(){o=[],x(),l()}}),$(".capacity-select").multiselect({includeSelectAllOption:!0,numberDisplayed:0,buttonClass:"btn btn-secondary",onChange:function(t,e){var n=t.val();e?o.includes(n)||o.push(n):o=o.filter(function(t){return t!==n}),x(),l()},onSelectAll:function(){o=s.map(function(t){return t.id}),x(),l()},onDeselectAll:function(){o=[],x(),l()}}),$(".category-select").multiselect({includeSelectAllOption:!0,numberDisplayed:0,buttonClass:"btn btn-secondary",onChange:function(t,e){return l()},onSelectAll:function(){return l()},onDeselectAll:function(){return l()}}),o=s.map(function(t){return t.id}),x(),A(),l(),$(".table-tab-container button").on("click",function(){$(this).addClass("active").siblings().removeClass("active");var t=$(this).val();$(".table-container").slideUp(),$("."+t+"-table-container").slideDown()});var w=[{name:"[level] ID",getValue:function(t){return t.id.toUpperCase()}},{name:"[level] Name",getValue:function(t){return t.name}},{name:"Startup Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.startupCost}},{name:"Capital Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.capitalCost}},{name:"Recurring Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.recurringCost}},{name:"1-Year Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.startupCost+t.capitalCost+t.recurringCost}},{name:"3-Year Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.startupCost+t.capitalCost+3*t.recurringCost}},{name:"5-Year Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.startupCost+t.capitalCost+5*t.recurringCost}}];function k(t,e,n){var r=d3.select(t);r.append("thead").append("tr").selectAll("th").data(w).enter().append("th").attr("class",function(t){return t.className||""}).text(function(t){return t.name.replace("[level]",n)});var a=r.append("tbody");a.selectAll("tr").data(e).enter().append("tr").selectAll("td").data(function(e){return w.map(function(t){return{rowData:e,colData:t}})}).enter().append("td").attr("class",function(t){return t.colData.className||""}).text(function(t){return(t.colData.format||function(t){return t})(t.colData.getValue(t.rowData))}),a.append("tr").attr("class","total-row").selectAll("td").data(w).enter().append("td").attr("class","cost").text(function(t){return"cost"===t.className?App.moneyFormatLong(d3.sum(e,t.getValue)):""})}k(".core-table",a,"Core Element"),k(".capacity-table",s,"Capacity"),k(".indicator-table",d,"Indicator"),k(".action-table",f,"Action"),$(".capacity-table-container").show(),$(".export-data-button").on("click",function(){NProgress.start(),App.exportLineItems(function(t){t&&noty({text:"<b>Warning!</b><br>There was an error exporting the detailed report. Please contact the administrators of the tool."}),NProgress.done()})}),$(".export-session-button").on("click",function(){var t=App.getSessionData(),e=new Date,n=e.getFullYear(),r=String(e.getMonth()+1);1===r.length&&(r="0"+r);var a=String(e.getDate());1===a.length&&(a="0"+a);var i=""+n+r+a,o=""+App.whoAmI.abbreviation+i;App.downloadText(o,t)}),$(".export-empty-template-button").on("click",function(){NProgress.start(),App.exportCostingWorksheet(function(){NProgress.done()})})},App.initScores=function(a,t){var i=Util.getIndicatorId(a).toLowerCase(),o=Util.getIndicatorId(a+"-"+t).toLowerCase(),s=App.getCapacity(i),c=App.getIndicator(o);function l(){var t=s.indicators.length,e=s.indicators.filter(function(t){return t.score}).length;d3.select(".indicator-progress").text("Select a score for each indicator ("+e+" of "+t+"):"),d3.select(".block-link-subtitle.active").text(e+" of "+t)}App.prevHash||(App.prevHash="");var e=App.prevHash.split("/");"scores"!==e[0]||e[1],App.prevHash=hasher.getHash(),App.buildTabNavigation(".block-link-container",i,{includeScoreBars:!0}),$(".capacity-description-container").html(Routing.templates["capacity-description"]()),App.buildCapacityDescription(i),"Immunization"===s.name&&$(".capacity-tooltip-img").show().tooltipster({interactive:!0,content:'An alternative method to estimate vaccination costs is available using the <a href="http://www.avenirhealth.org/software-onehealth.php" target="_blank">OneHealth Tool</a>'}),function(){l();var t=d3.select(".indicator-container").selectAll(".indicator-slot").data(s.indicators).enter().append("div").attr("class","indicator-slot").classed("active",function(t){return t.id===o}).classed("empty",function(t){return void 0===App.getIndicatorScore(t.id)}).on("click",function(t,e){hasher.setHash("scores/"+a+"/"+(e+1))});t.append("div").attr("class","indicator-name").text(function(t){return t.id.toUpperCase()+" - "+Util.truncateText(t.name)});var n=t.append("div").attr("class","indicator-score");n.append("span").attr("class","score-none").style("display",function(t){return App.getIndicatorScore(t.id)?"none":"inline"}).html("<i>No Score</i>");for(var e=function(e){n.append("img").attr("class","rp-score").attr("src","img/rp-"+e+".png").attr("alt",e).attr("score",e).style("display",function(t){return+App.getIndicatorScore(t.id)===e?"inline":"none"})},r=1;r<=5;r++)e(r);$(".indicator-description").html(o.toUpperCase()+" - "+c.name)}(),function(){var t=d3.select(".score-picker-table tbody").selectAll("tr").data(d3.range(1,6)).enter().append("tr").attr("class","score-row").classed("active",function(t){return t===c.score}).on("click",function(t){var e=d3.select(this),n=e.select("input").property("checked"),r=n?void 0:t,a=d3.selectAll(".score-row").classed("active",!1);a.select("input").property("checked",!1),a.select(".score-description-cell").text(function(t){var e=c.score_descriptions[t];return 300<e.length?e.slice(0,300)+"...":e}),e.classed("active",!n),e.select("input").property("checked",!n),d3.select(".score-row.active .score-description-cell").text(function(t){return c.score_descriptions[t]}),App.setIndicatorScore(o,r);var i=d3.select(".indicator-slot.active .indicator-score");r?(i.select(".score-none").style("display","none"),i.selectAll("img").style("display",function(){return+$(this).attr("score")==+t?"inline":"none"})):(i.select(".score-none").style("display","inline"),i.selectAll("img").style("display","none")),l()});t.append("td").append("input").attr("type","radio").property("checked",function(t){return t===c.score}).on("click",function(){$(this).prop("checked",!$(this).prop("checked"))});var e=t.append("td");e.append("img").attr("class","rp-score-table-img rp-score").attr("src",function(t){return"img/rp-"+t+".png"}),e.append("span").attr("class","score-label").text(function(t){return App.scoreLabels[t]}),t.append("td").attr("class","score-description-cell").text(function(t){var e=c.score_descriptions[t];return 300<e.length?e.slice(0,300)+"...":e}),t.append("td")}(),d3.select(".next-score").on("click",function(){var t=App.getNextIndicator(i,o).id;t||hasher.setHash("costsinstructions");var e=t.lastIndexOf("."),n=t.slice(0,e).replace(".","-"),r=t.slice(e+1);hasher.setHash("scores/"+n+"/"+r)}),d3.select(".previous-score").on("click",function(){var t=App.getPrevIndicator(i,o).id;if(t){var e=t.lastIndexOf("."),n=t.slice(0,e).replace(".","-"),r=t.slice(e+1);hasher.setHash("scores/"+n+"/"+r)}}),$(".go-to-costing-button").click(function(){return hasher.setHash("costsinstructions")})},function(){var w="#fff3cd",k=[{abbr:"population",name:"Population and Currency"},{abbr:"country-details",name:"Country Details"},{abbr:"default-costs",name:"Cost Assumptions (optional)",children:["personnel","technology","printing","meetings"]},{abbr:"personnel",tabName:"Personnel compensation",name:"Personnel Compensation",level:1},{abbr:"technology",name:"Technology and Infrastructure",level:1},{abbr:"printing",name:"Printing",level:1},{abbr:"meetings",name:"Meetings",level:1}];App.initWho=function(e){if("default-costs"!==e){switch(e){case"population":n();break;case"country-details":r();break;default:a(e)}var t=d3.select(".block-link-container").selectAll(".block-link").data(k).enter().append("div").attr("class","block-link").attr("level",function(t){return t.level}).classed("active",function(t){return t.children?t.children.includes(e):e===t.abbr}).style("display",function(t){return t.level?["personnel","technology","printing","meetings"].includes(e)?"inline-block":"none":"inline-block"}).on("click",function(t){return hasher.setHash("costs/"+t.abbr)});t.append("svg").attr("class","chevron").classed("active",function(t){return"default-costs"===t.abbr}).attr("viewBox","0 0 24 24").attr("src","img/chevron-right.png").style("display",function(t){return t.children&&t.children.includes(e)?"inline":e===t.abbr?"inline":"none"}).append("path").attr("d","M8 5v14l11-7z"),t.append("div").attr("class","block-link-title").html(function(t){return t.name}),t.append("div").attr("class","block-link-cover"),$(".defn").tooltipster({functionInit:function(t,e){var n=t._$origin.attr("defn");if("pop"===n){var r="This is the estimated total population for the country chosen. The number can be changed using the edit box below";return t.content(r),r}if("geo"===n){var a="This is the estimated total population for the country chosen. The number can be changed using the edit box below";return t.content(a),a}if("phi"===n){var i="This is the estimated total population for the country chosen. The number can be changed using the edit box below";return t.content(i),i}}})}else hasher.setHash("costs/personnel")};var n=function(){$(".population-block").slideDown();var e=App.countryParams.find(function(t){return t.name===App.whoAmI.name}).multipliers.population;$(".population-input").val(Util.comma(e)).on("change",function(){var t;App.whoAmI.multipliers.population=Util.getInputNumVal(this),t=Math.round(App.whoAmI.multipliers.population)===Math.round(e),$(".population-input").css("background-color",t?"#fff":w),t?$(".default-pop-text").slideUp():$(".default-pop-text").text("Default: "+Util.comma(e)).slideDown(),App.updateAllCosts()});var t=[];for(var n in App.currencies)t.push({name:App.currencies[n].name,code:App.currencies[n].iso.code});Util.sortByKey(t,"name"),Util.populateSelect(".currency-select",t,{nameKey:"name",valKey:"code"}),$(".currency-select").val(App.whoAmI.currency_iso).on("change",function(){App.whoAmI.currency_iso=$(this).val(),App.updateAllCosts()}),$(".next-button").click(function(){return hasher.setHash("costs/country-details")})},r=function(){$(".country-details-block").slideDown();var r="-- select one --",t=d3.select(".geo-division-table tbody").selectAll("tr").data([{nameAttr:"intermediate_1_area_name",valueAttr:"intermediate_1_area_count",description:"Intermediate (e.g., province, district)",nameValues:["Province","Municipality","District","State"]},{nameAttr:"intermediate_2_area_name",valueAttr:"intermediate_2_area_count",description:"Intermediate 2 (optional)",nameValues:["Province","Municipality","District","State","County"]},{nameAttr:"local_area_name",valueAttr:"local_area_count",description:"Local (e.g., county, city)",nameValues:["Barangay","City","Constituency","County","District"]}]).enter().append("tr");t.append("td").text(function(t){return t.description+":"}),t.append("td").append("select").attr("class","form-control").each(function(t){var e=[r].concat(t.nameValues);Util.populateSelect(this,e);var n=App.whoAmI[t.nameAttr];n&&$(this).val(n)}).on("change",function(t){var e=$(this).val();App.whoAmI[t.nameAttr]=e===r?"":e}),t.append("td").append("input").attr("class","form-control").attr("value",function(t){return Util.comma(App.whoAmI.multipliers[t.valueAttr])}).on("change",function(t){App.whoAmI.multipliers[t.valueAttr]=Util.getInputNumVal(this),App.updateAllCosts()});var e=d3.select(".ph-table tbody").selectAll("tr").data([{name:"central_hospitals_count",description:'Number of healthcare facilities in the country: <img class="committed-info-img info-img tooltipstered" id="healthcare-help" src="img/info.png">',unit:"healthcare facilities / country"},{name:"central_chw_count",description:"Number of community health workers in the country:",unit:"community health workers / country"}]).enter().append("tr");e.append("td").html(function(t){return""+t.description});var n=e.append("td");n.append("input").attr("class","form-control").attr("value",function(t){return t.defaultValue=App.whoAmI.multipliers[t.name],Util.comma(t.defaultValue)}).on("change",function(t){App.whoAmI.multipliers[t.name]=Util.getInputNumVal(this),App.updateAllCosts()}),n.append("span").text(function(t){return t.unit});$("#healthcare-help").tooltipster({content:"Specify the number of public healthcare facilities participating in IHR-related activities, including point-of-care diagnostics for priority diseases, and biosafety and biosecurity programs.",trigger:"hover",side:"top"}),$(".next-button").click(function(){return hasher.setHash("costs/personnel")}),$(".proceed-button").click(function(){return hasher.setHash("costs/p-1/1")})},a=function(n){$(".default-costs-block").slideDown();var c=App.getExchangeRate(),r=App.globalBaseCosts.filter(function(t){if(!t.show_on_dv)return!1;var e=k.find(function(t){return t.abbr===n});return e.tabName?t.tab_name===e.tabName:t.tab_name===e.name});if("personnel"===n&&r.push({cost:.6,cost_unit:"% per year",description:"Additional amount that will be budgeted for employee overhead expenses, as a percentage of the employee's annual salary",id:"gbc.overhead",name:"Overhead percentage",tab_name:"Personnel compensation",subheading_name:"Salaries"}),"technology"===n&&r.push({type:"radio",values:["Buy","Lease"],description:"Choice of either buying or leasing facility space",name:"Buy or lease facility space",tab_name:"Technology and Infrastructure",subheading_name:"Infrastructure"}),"meetings"===n)for(var t=0;t<App.globalStaffMultipliers.length;t++)r.push(App.globalStaffMultipliers[t]);r.forEach(function(t){"Printing"===t.tab_name&&(t.subheading_name="Printing")});for(var l=_.unique(_.pluck(r,"tab_name")),p=[],e=function(t){var a=l[t],i={};i[a]=[];for(var o=r.filter(function(t){return t.tab_name===a}),s=_.unique(_.pluck(o,"subheading_name")),e=function(t){var e=s[t],n={};n[e]=[];var r=o.filter(function(t){return t.subheading_name===e});n[e]=r,i[a].push(n)},n=0;n<s.length;n++)e(n);p.push(i)},a=0;a<l.length;a++)e(a);for(var i=0;i<p.length;i++){var o=p[i],s=Object.keys(o)[0];0<i&&d3.select(".dv-container").append("div").attr("class","dv-divider");for(var u=d3.select(".dv-container").append("div").attr("class","dv-tab-content"),d=0;d<o[s].length;d++){var f=u.append("div").attr("class","dv-subheading-row").append("div").attr("class","dv-subheading-col"),h=o[s][d],m=Object.keys(h)[0];f.append("h3").attr("class","dv-h3").text(m);for(var g=0;g<h[m].length;g++){var v=h[m][g],b=v.name,A=f.append("div").attr("class","dv-item-row row").append("div").attr("class","dv-item-col col-sm-12"),y=A.append("div").attr("class","dv-item-name-container");y.append("div").attr("class","dv-item-name").append("b").text(b),y.append("div").attr("class","dv-description").text(v.description);var C=A.append("div").attr("class","dv-input-group");if(v.id)C.append("input").attr("class","dv-input form-control").attr("gbcid",v.id),-1<v.id.indexOf("gbc")?("Overhead percentage"!==b&&C.append("span").attr("class","dv-currency"),C.append("span").attr("class","dv-cost-unit").text(" "+v.cost_unit)):C.append("span").attr("class","dv-cost-unit").text(" attendees"),C.append("div").attr("class","dv-default-text default-text");else C.append("div").attr("class","btn-group").selectAll("div").data(v.values).enter().append("div").attr("class","btn btn-secondary").classed("active",function(t){return t.toLowerCase()===User.buyOrLease}).text(function(t){return t}).on("click",function(t){$(this).addClass("active").siblings().removeClass("active"),User.buyOrLease=t.toLowerCase(),App.updateAllCosts()})}}}function x(e,t){var n=d3.select(t),r=!0,a="Default: ";if(-1<e.indexOf("gbc")){if("gbc.overhead"===e)r=.6===App.whoAmI.staff_overhead_perc,a+="60";else if(null!==e){var i=App.globalBaseCosts.find(function(t){return t.id===e});r=Math.round(i.default_cost)===Math.round(i.cost),a+=Util.comma(i.default_cost*c)}}else{var o=App.globalStaffMultipliers.find(function(t){return t.id===e});r=o.default_count===o.count,a+=Util.comma(o.default_count)}n.style("background-color",function(){return r?"#fff":w});var s=$(d3.select(n.node().parentNode).select(".dv-default-text").node());r?s.slideUp():s.text(a).slideDown()}$(".dv-input").on("change",function(){var e=d3.select(this).attr("gbcid");if(-1<e.indexOf("gbc")){if("gbc.overhead"===e)App.whoAmI.staff_overhead_perc=Util.getInputNumVal(this)/100;else if(null!==e){App.globalBaseCosts.find(function(t){return t.id===e}).cost=Util.getInputNumVal(this)/c}}else App.globalStaffMultipliers.find(function(t){return t.id===e}).count=Util.getInputNumVal(this);x(e,this),App.updateAllCosts()}),d3.selectAll(".dv-input").each(function(){var t=d3.select(this),e=t.attr("gbcid");if(-1<e.indexOf("gbc")){if("gbc.overhead"===e)t.node().value=Util.comma(100*App.whoAmI.staff_overhead_perc);else if(null!==e){var n=App.globalBaseCosts.find(function(t){return t.id===e});t.node().value=Util.comma(n.cost*c)}}else{var r=App.globalStaffMultipliers.find(function(t){return t.id===e});t.node().value=Util.comma(r.count)}$(".dv-currency").text(App.whoAmI.currency_iso),x(e,this)}),$(".proceed-button").click(function(){return hasher.setHash("costs/p-1/1")})}}();