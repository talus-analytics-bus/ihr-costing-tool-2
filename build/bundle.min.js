"use strict";var Util={};Util.comma=d3.format(",.0f"),Util.decimalOne=d3.format(".1f"),Util.decimalTwo=d3.format(".2f"),Util.percentize=d3.format("%"),Util.percentizeDec=d3.format(".1%"),Util.monetize=d3.format("$,f"),Util.formatSI=d3.format(".2s"),Util.strToFloat=function(t){return"string"!=typeof t?t:parseFloat(t.replace(/[^\d\.\-]/g,""))},Util.capitalize=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},Util.getIndicatorClass=function(t){return t.split(".").join("-")},Util.getIndicatorId=function(t){return t.split("-").join(".")},Util.sortByKey=function(t,e,n){return t.sort(function(t,n){return t[e]<n[e]?-1:t[e]>n[e]?1:0}),n?t.reverse():t},Util.truncateText=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,n=t.split(" ");if(1===n.length||t.length<=e)return t;for(var r="",a=0,o=0;o<n.length&&a+n[o].length<e;)o>0&&(r+=" "),r+=n[o],a+=n[o].length,o++;return r+"..."},Util.populateSelect=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};void 0===n.valKey&&(n.valKey=""),void 0===n.nameKey&&(n.nameKey="");var r=d3.select(t).selectAll("option").data(e);r.exit().remove(),r=r.enter().append("option").merge(r).attr("value",function(t){return"function"==typeof n.valKey?n.valKey(t):""===n.valKey?t:t[n.valKey]}).text(function(t){return"function"==typeof n.nameKey?n.nameKey(t):""===n.nameKey?t:t[n.nameKey]}),n.selected&&("boolean"==typeof n.selected?r.attr("selected",n.selected):"function"==typeof n.selected&&r.attr("selected",function(){if(n.selected($(this).attr("value")))return!0}))},Util.strToFloat=function(t){return"string"!=typeof t?t:parseFloat(t.replace(/[^\d\.\-]/g,""))},Util.getInputNumVal=function(t){var e=$(t),n=Util.strToFloat(e.val());return""===n?0:isNaN(n)||n<0?(e.val(0),0):(e.val(d3.format(",")(n)),n)},Util.msieversion=function(){return!!(window.navigator.userAgent.indexOf("MSIE ")>0||navigator.userAgent.match(/Trident.*rv\:11\./))};var User={};User.targetScoreType="target",User.targetScore=4,User.buyOrLease="lease";var App={};App.demoMode=!1,App.scoreLabels={1:"No Capacity",2:"Limited Capacity",3:"Developed Capacity",4:"Demonstrated Capacity",5:"Sustainable Capacity"},App.initialize=function(t){var e=navigator.userAgent;-1===e.search("Chrome")&&-1===e.search("Firefox")&&noty({timeout:!1,maxWidth:400,text:"<b>Warning!<br>This tool is designed to be used in Google Chrome or Mozilla Firefox! Please switch to one of these browsers for optimal performance.</b>"}),$(".tool-name").click(function(){return hasher.setHash("")}),$(".nav-item").click(function(){var t=$(this).attr("page");void 0!==t&&hasher.setHash(t)}),$(".dropdown-item").click(function(){hasher.setHash($(this).attr("page"))}),d3.queue().defer(d3.json,"data/country_specific_parameters.json").defer(d3.json,"data/jee_costing_data.json").defer(d3.json,"data/currencies.json").defer(d3.json,"data/global_base_costs.json").defer(d3.json,"data/global_staff_multipliers.json").await(function(e,n,r,a,o,i){e?noty({type:"error",text:"Error loading data files. Please contact the tool administrator"}):(App.countryParams=n,App.jeeTree=r,App.currencies=a,App.globalBaseCosts=o,App.globalStaffMultipliers=i,App.whoAmI={},App.demoMode?d3.text("data/KE20170904-demo.ihr",function(e,n){App.loadSessionData(n)||noty({text:"There was an issue loading the demo data."}),App.updateAllCosts(),t()}):(App.updateAllCosts(),t()))})},App.siFormat=function(t){return d3.format(",.3s")(t).replace("G","B")},App.numberFormat=function(t){return t<=100?Math.round(t):t<=1e6?d3.format(",.3r")(t):App.siFormat(t)},App.moneyFormat=function(t){return App.numberFormat(t)+" "+App.whoAmI.currency_iso},App.moneyFormatShort=function(t){return App.siFormat(t)+" "+App.whoAmI.currency_iso},App.moneyFormatLong=function(t){return d3.format(",")(t)+" "+App.whoAmI.currency_iso},App.normalCcIds=["p","d","r"],App.getCapacity=function(t){var e=t.includes(".")?t.split(".")[0].toLowerCase():"o",n=t.toLowerCase(),r=App.jeeTree.find(function(t){return t.id===e});return r?r.capacities.find(function(t){return t.id===n}):null},App.getIndicator=function(t){var e=App.normalCcIds.includes(t.split(".")[0])?2:1,n=t.split(".").slice(0,e).join(".").toLowerCase(),r=t.toLowerCase(),a=App.getCapacity(n);return a?a.indicators.find(function(t){return t.id===r}):null},App.getPrevIndicator=function(t,e){var n=t.includes(".")?t.split(".")[0].toLowerCase():"o",r=App.jeeTree.findIndex(function(t){return t.id===n}),a=App.jeeTree[r],o=a.capacities.findIndex(function(e){return e.id===t}),i=a.capacities[o],s=i.indicators.findIndex(function(t){return t.id===e});if(s>0)return i.indicators[s-1];if(o>0){var c=a.capacities[o-1];return c.indicators[c.indicators.length-1]}if(r>0){var l=App.jeeTree[r-1],p=l.capacities[l.capacities.length-1];return p.indicators[p.indicators.length-1]}return null},App.getNextIndicator=function(t,e){var n=t.includes(".")?t.split(".")[0].toLowerCase():"o",r=App.jeeTree.findIndex(function(t){return t.id===n}),a=App.jeeTree[r],o=a.capacities.findIndex(function(e){return e.id===t}),i=a.capacities[o],s=i.indicators.findIndex(function(t){return t.id===e});return s<i.indicators.length-1?i.indicators[s+1]:o<a.capacities.length-1?a.capacities[o+1].indicators[0]:r<App.jeeTree.length-1?App.jeeTree[r+1].capacities[0].indicators[0]:null},App.getAction=function(t){var e=App.normalCcIds.includes(t.split(".")[0])?3:2,n=t.split(".").slice(0,e).join(".").toLowerCase(),r=t.toLowerCase(),a=App.getIndicator(n);return a?a.actions.find(function(t){return t.id===r}):null},App.getInput=function(t){var e=App.normalCcIds.includes(t.split(".")[0])?4:3,n=t.split(".").slice(0,e).join(".").toLowerCase(),r=t.toLowerCase(),a=App.getAction(n);return a?a.inputs.find(function(t){return t.id===r}):null},App.getLineItem=function(t){var e=App.normalCcIds.includes(t.split(".")[0])?5:4,n=t.split(".").slice(0,e).join(".").toLowerCase(),r=t.toLowerCase(),a=App.getInput(n);return a?a.line_items.find(function(t){return t.id===r}):null},App.getNeededActions=function(t){return t.score?t.actions.filter(function(e){return App.getNeededInputs(e.inputs,t.score).length}):[]},App.getNeededInputs=function(t,e){return e?t.filter(function(t){return App.getNeededLineItems(t.line_items,e).length}):t},App.getNeededLineItems=function(t,e){if(!e)return t;if("step"===User.targetScoreType)return t.filter(function(t){return t.score_step_to.includes(String(+e+1))});if("target"===User.targetScoreType){var n=d3.range(+e+1,User.targetScore+1);return t.filter(function(t){for(var e=0;e<t.score_step_to.length;e++)if(n.includes(+t.score_step_to[e]))return!0;return!1})}return[]},App.getIndicatorScore=function(t){return App.getIndicator(t).score},App.getAverageCurrentScore=function(t){var e=[];return t.forEach(function(t){t.score&&e.push(t.score)}),d3.mean(e)},App.getAverageTargetScore=function(t){var e=[];return t.forEach(function(t){t.score&&e.push(App.getTargetScore(t))}),d3.mean(e)},App.getTargetScore=function(t){if("step"===User.targetScoreType){if(t.score)return t.score>=4?t.score:t.score+1}else if("target"===User.targetScoreType)return t.score&&t.score>User.targetScore?t.score:User.targetScore;return null},App.setIndicatorScore=function(t,e){App.getIndicator(t).score=e},App.updateAllCosts=function(){var t=App.getExchangeRate();App.jeeTree.forEach(function(e){e.startupCost=0,e.capitalCost=0,e.recurringCost=0,e.capacities.forEach(function(n){n.startupCost=0,n.capitalCost=0,n.recurringCost=0,n.indicators.forEach(function(e){e.startupCost=0,e.capitalCost=0,e.recurringCost=0,e.actions.forEach(function(n){n.startupCost=0,n.capitalCost=0,n.recurringCost=0,n.inputs.forEach(function(e){e.startupCost=0,e.capitalCost=0,e.recurringCost=0,e.line_items.forEach(function(n){n.cost=App.getLineItemCost(n,t),"start-up"===n.line_item_type?e.startupCost+=n.cost:"capital"===n.line_item_type?e.capitalCost+=n.cost:"recurring"===n.line_item_type&&(e.recurringCost+=n.cost)}),e.costed&&(e.isCustomCost?(n.startupCost+=e.customStartupCost,n.recurringCost+=e.customRecurringCost):(n.startupCost+=e.startupCost,n.capitalCost+=e.capitalCost,n.recurringCost+=e.recurringCost))}),App.isActionComplete(n,e.score)&&(e.startupCost+=n.startupCost,e.capitalCost+=n.capitalCost,e.recurringCost+=n.recurringCost)}),n.startupCost+=e.startupCost,n.capitalCost+=e.capitalCost,n.recurringCost+=e.recurringCost}),e.startupCost+=n.startupCost,e.capitalCost+=n.capitalCost,e.recurringCost+=n.recurringCost})})},App.getLineItemCost=function(t,e){var n=App.globalBaseCosts.find(function(e){return e.id===t.base_cost});if(!n)if(n=App.globalBaseCosts.find(function(e){return e.id===t.base_cost+"."+User.buyOrLease}),"buy"===User.buyOrLease)t.line_item_type="start-up",t.score_step_to=[String(d3.min(t.score_step_to))];else{t.line_item_type="recurring";for(var r=[],a=+d3.min(t.score_step_to);a<5;a++)r.push(String(a));t.score_step_to=r.slice(0)}if(!n)return console.log("Warning! Cost object not found for id: "+t.base_cost),0;var o=n?n.cost:0;if(t.staff_multiplier){var i=App.globalStaffMultipliers.find(function(e){return e.id===t.staff_multiplier});i&&(o*=i.count)}if(t.country_multiplier&&App.whoAmI.name){var s=1;(s="intermediate_1_and_local_area_count"===t.country_multiplier?App.whoAmI.multipliers.intermediate_1_area_count+App.whoAmI.multipliers.local_area_count:App.whoAmI.multipliers[t.country_multiplier])&&(o*=s)}return t.custom_multiplier_1&&(o*=App.getMultiplierValue(t.custom_multiplier_1)),t.custom_multiplier_2&&(o*=App.getMultiplierValue(t.custom_multiplier_2)),n&&"Salaries"===n.subheading_name&&(o*=1+App.whoAmI.staff_overhead_perc),o*=e||App.getExchangeRate(),Math.round(o)},App.getCostText=function(t){var e=t.startupCost+t.capitalCost,n=t.recurringCost;return n?App.moneyFormat(e)+" + "+App.moneyFormat(n)+"/yr":App.moneyFormat(e)},App.getCustomCostText=function(t){return t.isCustomCost?App.moneyFormat(t.customStartupCost)+" + "+App.moneyFormat(t.customRecurringCost)+"/yr":""},App.getNumIndicatorsCosted=function(t){return t.indicators.filter(function(t){return App.isIndicatorComplete(t)}).length},App.getExchangeRate=function(){return App.whoAmI.name?App.currencies[App.whoAmI.currency_iso].exchange_rates.find(function(t){return"USD"===t.convert_from}).multiplier:1},App.getMultiplierValue=function(t){if("number"==typeof t)return t;var e=t.split(" ");return parseFloat(e[0])},App.isIndicatorComplete=function(t){return!!t.score&&App.getNeededActions(t).every(function(e){return App.isActionComplete(e,t.score)})},App.isActionComplete=function(t,e){return!!e&&App.getNeededInputs(t.inputs,e).every(function(t){return t.costed})},App.getCompleteIndicatorTree=function(){var t=[];return App.jeeTree.forEach(function(e){e.capacities.forEach(function(e){e.indicators.forEach(function(e){if(App.isIndicatorComplete(e)){var n=Object.assign({},e),r=App.getNeededActions(n);n.targetScore=App.getTargetScore(n),n.actions=[],r.forEach(function(t){if(App.isActionComplete){var r=Object.assign({},t),a=r.inputs.filter(function(t){return t.costed}),o=App.getNeededInputs(a,e.score);r.inputs=[],o.forEach(function(t){var n=Object.assign({},t),a=App.getNeededLineItems(n.line_items,e.score);n.line_items=[],a.forEach(function(t){var e=Object.assign({},t);n.line_items.push(e)}),r.inputs.push(n)}),n.actions.push(r)}}),t.push(n)}})})}),t},App.getAllIndicatorTree=function(){var t=[];return App.jeeTree.forEach(function(e){e.capacities.forEach(function(e){e.indicators.forEach(function(e){t.push(e)})})}),t},App.downloadText=function(t,e){var n="data:application/csv;charset=utf-8,"+escape(e),r=document.createElement("a");r.href=n,r.style="visibility:hidden",r.download=t+".ihr",document.body.appendChild(r),r.click(),document.body.removeChild(r)},$.tooltipster.setDefaults({contentAsHTML:!0,trigger:"hover",offset:[5,-25],theme:"tooltipster-shadow",maxWidth:320}),$.noty.defaults.type="warning",$.noty.defaults.layout="center",$.noty.defaults.timeout=2e3;var Routing={};!function(){function t(t,n){if(!App.whoAmI.abbreviation&&a.includes(t))return hasher.setHash("country"),void noty({timeout:5e3,text:"<b>No country selected!</b><br>Please select a country and complete assessment before entering costs.</b>"});r(t);for(var o=arguments.length,i=Array(o>2?o-2:0),s=2;s<o;s++)i[s-2]=arguments[s];e.apply(void 0,[t].concat(i)),n&&n.apply(void 0,i)}function e(t){"home"===t&&(t=""),d3.selectAll(".nav-item").classed("active",function(){return $(this).attr("page")===t})}function n(t){crossroads.parse(t)}function r(t,e){$("#page-content").html(Routing.templates[t](e))}Routing.templates={},Routing.precompileTemplates=function(){$("script[type='text/x-handlebars-template']").each(function(t,e){Routing.templates[e.id.replace("-template","")]=Handlebars.compile($(e).html())})},Routing.initializeRoutes=function(){crossroads.addRoute("/",function(){t("home",App.initHome),window.scrollTo(0,0)}),crossroads.addRoute("/country",function(){t("country",App.initCountry),window.scrollTo(0,0)}),crossroads.addRoute("/overview",function(){t("overview",App.initOverview),window.scrollTo(0,0)}),crossroads.addRoute("/scores",function(){hasher.setHash("scores/p-1/1")}),crossroads.addRoute("/scores/:{ccId}:",function(t){hasher.setHash("scores/"+t+"/1")}),crossroads.addRoute("/scores/:{ccId}:/:{indId}:",function(e,n){void 0===n&&void 0!==e?(n="1",hasher.setHash("scores/"+e+"/"+n)):void 0===n&&void 0===e&&(n="1",e="p-1",hasher.setHash("scores/"+e+"/"+n)),t("scores",App.initScores,e,n)}),crossroads.addRoute("/costsinstructions",function(){t("costs-instructions",App.initCostsInstructions),window.scrollTo(0,0)}),crossroads.addRoute("/costs",function(){hasher.setHash("costs/population")}),crossroads.addRoute("/costs/:{whoTab}:",function(e){t("who",App.initWho,e),window.scrollTo(0,0)}),crossroads.addRoute("/costs/:{ccId}:/:{indId}:",function(e,n){!n&&e?(n="1",hasher.setHash("costs/"+e+"/"+n)):n||e||(n="1",e="p-1",hasher.setHash("costs/"+e+"/"+n)),t("costs",App.initCosting,e,n),window.scrollTo(0,0)}),crossroads.addRoute("/results",function(){t("results",App.initResults),window.scrollTo(0,0)}),crossroads.addRoute("/background",function(){t("background",App.initBackground),window.scrollTo(0,0)}),crossroads.addRoute("/contact",function(){t("contact",App.initContact),window.scrollTo(0,0)}),hasher.prependHash="",hasher.initialized.add(n),hasher.changed.add(n),hasher.init()};var a=["who","costs","results"]}(),NProgress.start(),App.initialize(function(){Routing.precompileTemplates(),Routing.initializeRoutes(),NProgress.done()}),App.buildCapacityDescription=function(t){var e=App.getCapacity(t);d3.selectAll(".capacity-name").text(t.toUpperCase()+" - "+e.name),d3.selectAll(".capacity-target").text(e.target_description),e.desired_impact?d3.selectAll(".capacity-desired-impact").text(e.desired_impact):d3.selectAll(".capacity-desired-impact-container").style("display","none"),e.notes?d3.selectAll(".capacity-additional-notes").text(e.notes):d3.selectAll(".capacity-additional-notes-container").style("display","none"),$(".capacity-description-header").click(function(){$(".capacity-description-details").toggle(),$("#chevron").toggleClass("rotate-chevron")})};var Charts={};Charts.buildProgressChart=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r={top:35,right:45,bottom:35,left:5},a=n.width||660,o=n.height||36,i=d3.selectAll(t).append("svg").classed("progress-chart",!0).attr("width",a+r.left+r.right).attr("height",o+r.top+r.bottom),s=i.append("g").attr("transform","translate("+r.left+", "+r.top+")"),c=n.radius||9,l=n.rectHeight||o/2,p=d3.scaleLinear().domain([1,5]).range([0,a]),u=i.append("defs");u.append("filter").attr("id","blur").append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation","1");var d=u.append("pattern").attr("id","diagonalHatch").attr("patternUnits","userSpaceOnUse").attr("width",4).attr("height",4);d.append("rect").attr("x",-1).attr("y",-1).attr("width",6).attr("height",6).attr("fill","white").attr("stroke","none"),d.append("path").attr("d","M-1,1 l2,-2, M0,4 l4,-4, M3,5 l2,-2").attr("stroke","black").attr("stroke-width",.5);var f=[{x0:1,x1:2,color:"rgb(200, 33, 39)"},{x0:2,x1:4,color:"rgb(247, 236, 19)"},{x0:4,x1:5,color:"rgb(21, 108, 55)"}];return s.selectAll(".color-bar").data(f).enter().append("rect").attr("class","color-bar").attr("x",function(t){return p(t.x0)}).attr("width",function(t){return p(t.x1)-p(t.x0)}).attr("height",o).style("fill",function(t){return t.color}).attr("filter","url(#blur)"),s.append("rect").attr("class","base").attr("width",a).attr("height",o),s.append("rect").attr("class","bar bar-0").attr("x",p(1)).attr("y",(o-l)/2).attr("width",p(e[0])-p(1)).attr("height",l).attr("fill","#777"),s.append("rect").attr("class","bar bar-1").attr("x",p(e[0])).attr("y",(o-l)/2).attr("width",p(e[1])-p(e[0])).attr("height",l).attr("fill","url(#diagonalHatch)"),s.append("circle").attr("class","marker marker-0").attr("cx",p(e[0])).attr("cy",o/2).attr("r",c),s.append("circle").attr("class","marker marker-1").attr("cx",p(e[1])).attr("cy",o/2).attr("r",c),s.append("line").attr("class","label-line").attr("x1",p(e[0])).attr("x2",p(e[0])).attr("y1",-10).attr("y2",o/2-c),s.append("text").attr("class","label-text").attr("x",p(e[0])).attr("y",-21).attr("dy",".35em").text("Current Score"),s.append("line").attr("class","label-line").attr("x1",p(e[1])).attr("x2",p(e[1])).attr("y1",o+10).attr("y2",o/2+c),s.append("text").attr("class","label-text").attr("x",p(e[1])).attr("y",o+21).attr("dy",".35em").text("Target Score"),s},Charts.buildCostChart=function(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var e={top:70,right:30,bottom:70,left:100},n=d3.select(t).append("svg").attr("class","cost-chart").attr("width",810+e.left+e.right).attr("height",320+e.top+e.bottom),r=n.append("g").attr("transform","translate("+e.left+", "+e.top+")");n.append("defs").append("clipPath").attr("id","chart-clip").append("rect").attr("y",-e.top).attr("width",810+e.right).attr("height",320+e.top);var a=d3.scaleBand().range([0,810]),o=d3.scaleLinear().range([320,0]),i=d3.scaleLinear().domain([0,810]).range(["rgb(255, 0, 0)","rgb(0, 66, 118)"]),s=d3.scaleLinear().domain([320,0]).range([5,25]),c=d3.axisBottom(),l=d3.axisLeft().ticks(6).tickSizeInner(-810).tickFormat(function(t){return 0===t?"0":App.siFormat(t)}),p=r.append("g").attr("class","x axis").attr("transform","translate(0, 320)"),u=r.append("g").attr("class","y axis"),d=r.append("g").attr("clip-path","url(#chart-clip)"),f=r.append("text").attr("class","axis-label x-axis-label").attr("x",5).attr("y",380),h=r.append("text").attr("class","axis-label y-axis-label-1").attr("y",-32);return r.append("text").attr("class","axis-label y-axis-label-2").attr("y",-15).text("(in "+App.whoAmI.currency_iso+")"),r.update=function(t,e,n){var f=t||r.currData;t&&(r.currData=t);var h=e||r.currXValFunc;e&&(r.currXValFunc=e);var m=n||r.currYValFunc;n&&(r.currYValFunc=n),a.domain(f.map(h)),o.domain([0,1.1*d3.max(f,m)]),c.scale(a),l.scale(o),p.call(c),u.call(l);var g=a.bandwidth();p.selectAll(".tick text").call(wrap,g),p.selectAll(".tick text").each(function(t){if(!$(this).hasClass("tooltipstered")){var e=App.getCapacity(t);if(e)return void $(this).tooltipster({content:"<b>"+t+"</b> - "+e.name});var n=App.getIndicator(t.toLowerCase());if(n)return void $(this).tooltipster({content:"<b>"+t+"</b> - "+n.name})}}),u.selectAll(".tick text").attr("x",-11);var v=d.selectAll(".indicator-blob").data(f);v.exit().remove(),v.enter().append("circle").attr("class","indicator-blob").each(function(){$(this).tooltipster({maxWidth:400,interactive:!0,content:""})}).merge(v).on("click",function(t){if("indicator"===t.type){var e=[];App.getCapacity(t.capId).indicators.forEach(function(t){e=e.concat(t.actions)});r.update(e,function(t){var e=t.id.split(".");return e.pop(),e.join(".").toUpperCase()},m)}}).transition().duration(1200).attr("r",function(t){return s(o(m(t)))}).attr("cx",function(t){return a(h(t))+g/2+g/2*(Math.random()-.5)}).attr("cy",function(t){return o(m(t))}).style("fill",function(t){return i(a(h(t)))}).each(function(t,e){var n=[{name:"Startup Cost",value:t.startupCost},{name:"Capital Cost",value:t.capitalCost},{name:"Recurring Cost",value:t.recurringCost,unit:"/yr"}],r=d3.select(document.createElement("div")),a=r.append("div").attr("class","cc-tooltip");a.append("div").attr("class","cc-tooltip-title").text(Util.capitalize(t.type)+" ("+t.id.toUpperCase()+")"),a.append("div").attr("class","cc-tooltip-subtitle").text(t.name);var o=a.selectAll(".cc-tooltip-block").data(n).enter().append("div").attr("class","cc-tooltip-block");o.append("div").text(function(t){var e=App.moneyFormat(t.value);return t.unit?e+t.unit:e}),o.append("div").text(function(t){return t.name});var i=a.append("div").attr("class","cc-tooltip-button-container").append("button").attr("class","cc-tooltip-button btn btn-secondary").text("Go to Costing");if("indicator"===t.type){var s=t.id.split("."),c="hasher.setHash('costs/"+s.slice(0,s.length-1).join("-")+"/"+s[s.length-1]+"')";i.attr("onClick",c)}else if("action"===t.type){console.log(t);var l=t.id.split("."),p="hasher.setHash('costs/"+l.slice(0,l.length-2).join("-")+"/"+l[l.length-2]+"')";i.attr("onClick",p)}$(this).tooltipster("content",r.html())})},r.updateXAxisLabel=function(t){f.text(t)},r.updateYAxisLabel=function(t){h.text(t)},r},Charts.buildBubblePack=function(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r={"Coordination / leadership":"#f2f0f7","Planning including assessment, design, planning, policy, legislation":"#dadaeb","Strengthening HR capacity":"#bcbddc","Strengthening infrastructure":"#9e9ac8","Operations / implementation":"#807dba","Analysis including data quality and dissemination":"#6a51a3","Use and review mechanisms":"#4a1486"},a={top:60,right:30,bottom:60,left:95},o=d3.select(t).append("svg").attr("class","bubble-chart").attr("width",580+a.left+a.right).attr("height",300+a.top+a.bottom).append("g").attr("class","bubble-pack").attr("transform","translate("+a.left+", "+a.top+")"),i=[],s=0;s<Object.keys(e).length;s++){var c={},l=Object.keys(e)[s];c.name=l,"total"===n.costType&&(c.value=e[l]["start-up"]+e[l].recurring*n.totalCostDuration+e[l].capital),i.push(c)}e=i;var p=o,u=d3.format(",d"),d=(d3.scaleOrdinal(d3.schemeCategory20),d3.pack().size([580,300]).padding(1.5)),f=d3.forceCollide(function(t){return t.r+1}),h=d3.forceSimulation().force("charge",d3.forceManyBody()).force("collide",f).force("x",d3.forceX(290).strength(.05)).force("y",d3.forceY(150).strength(.05)),m=d(d3.hierarchy({children:e}).sum(function(t){return t.value})).leaves().map(function(t){var e=t.data;return{x:290+3*(t.x-290),y:150+3*(t.y-150),r:0,radius:t.r+5,id:e.cat,cat:e.cat,name:e.name,value:e.value,icon:e.icon,desc:e.desc}});h.nodes(m).on("tick",function(){g.attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).select("circle").attr("r",function(t){return t.r})}),p.style("background-color","#eee");var g=p.selectAll(".node").data(m).enter().append("g").attr("class","node").call(d3.drag().on("start",function(t){d3.event.active||h.alphaTarget(.2).restart(),t.fx=t.x,t.fy=t.y}).on("drag",function(t){t.fx=d3.event.x,t.fy=d3.event.y}).on("end",function(t){d3.event.active||h.alphaTarget(0),t.fx=null,t.fy=null}));g.append("circle").attr("id",function(t){return t.id}).attr("r",0).attr("class","bubble").attr("stroke-width","1px").transition().duration(2e3).ease(d3.easeElasticOut).tween("circleIn",function(t){var e=d3.interpolateNumber(0,t.radius);return function(n){t.r=e(n),h.force("collide",f)}}),g.append("clipPath").attr("id",function(t){return"clip-"+t.id}).append("use").attr("xlink:href",function(t){return"#"+t.id}),g.append("title").text(function(t){return t.name+"\n"+u(t.value)}),g.on("mouseover",function(t){d3.select(this).select("circle").attr("stroke-width","3px").attr("stroke","black")}),g.on("mouseout",function(t){d3.select(this).select("circle").attr("stroke",function(t){return d3.color(r[t.name]).darker().toString()}).attr("stroke-width","1px")})};var Colors={};Colors.jeeRed="#C12025",Colors.jeeYellow="#EDE929",Colors.jeeGreen="#87C764",Colors.scoreColors={1:Colors.jeeRed,2:Colors.jeeYellow,3:Colors.jeeYellow,4:Colors.jeeGreen,5:Colors.jeeGreen,"":"#bbb"},App.definitions={totalCost:"The <b>total cost</b>, depending on the duration selected, is the sum of the startup cost, capital cost, and recurring costs.",startupCost:"The <b>startup cost</b> refers to non-recurring costs.",capitalCost:"The <b>capital cost</b> refers to salary related capital expenditures.",recurringCost:"The <b>recurring cost</b> refers to annual operating costs."},App.getSessionData=function(){var t={},e={};return App.jeeTree.forEach(function(n){n.capacities.forEach(function(n){n.indicators.forEach(function(n){t[n.id]=n.score||0,n.actions.forEach(function(t){t.inputs.forEach(function(t){var n={costed:t.costed,isCustomCost:t.isCustomCost};t.isCustomCost&&(n.customStartupCost=t.customStartupCost,n.customRecurringCost=t.customRecurringCost),e[t.id]=n})})})})}),JSON.stringify({whoAmI:App.whoAmI,scoreData:t,costData:e,user:User})},App.loadSessionData=function(t){var e=void 0;try{e=JSON.parse(t)}catch(t){return!1}for(var n in e.user)User[n]=e.user[n];App.whoAmI=e.whoAmI;var r=e.scoreData,a=e.costData;return App.jeeTree.forEach(function(t){t.capacities.forEach(function(t){t.indicators.forEach(function(t){r[t.id]&&(t.score=r[t.id]),t.actions.forEach(function(t){t.inputs.forEach(function(t){if(a[t.id])for(var e in a[t.id])t[e]=a[t.id][e]})})})})}),!0},App.loadQlickScoreData=function(t){var e=void 0;try{e=XLSX.read(t,{type:"binary"})}catch(t){return!1}var n=e.SheetNames[0],r=e.Sheets[n];return r.A1.w="country_name",r.B1.w="capacity_name",r.C1.w="indicator_name",r.D1.w="score",XLSX.utils.sheet_to_json(r,{defval:""}).forEach(function(t){var e=t.indicator_name.split(" ")[0].toLowerCase();if(""!==e){var n=+t.score;!isNaN(n)&&n>=1&&n<=5&&App.setIndicatorScore(e,n)}}),!0},App.exportLineItems=function(t){var e=App.getCompleteIndicatorTree(),n=new XMLHttpRequest;n.open("POST","/lineItemExport",!0),n.responseType="blob",n.setRequestHeader("Content-type","application/json"),n.onload=function(e){if(200==this.status){var n=new Blob([this.response],{type:"application/vnd.ms-excel"}),r=URL.createObjectURL(n),a=document.createElement("a");a.href=r;var o=new Date,i=o.getFullYear(),s=String(o.getMonth()+1);1===s.length&&(s="0"+s);var c=String(o.getDate());1===c.length&&(c="0"+c);var l=""+i+s+c+" "+App.whoAmI.abbreviation;return a.download="IHR Costing Tool - Detailed Report - "+l+".xlsx",document.body.appendChild(a),a.click(),void(t&&t(null))}t&&t(this.status)},App.whoAmI.staff_overhead_perc_str=Util.percentizeDec(App.whoAmI.staff_overhead_perc),n.send(JSON.stringify({exportType:"userData",indicators:e,currencyCode:App.whoAmI.currency_iso,exchangeRate:App.getExchangeRate(),whoAmI:App.whoAmI,gbc:App.globalBaseCosts,gsm:App.globalStaffMultipliers,User:User}))},App.exportCostingWorksheet=function(t){var e=App.getAllIndicatorTree(),n=new XMLHttpRequest;n.open("POST","/lineItemExport",!0),n.responseType="blob",n.setRequestHeader("Content-type","application/json"),n.onload=function(e){if(200==this.status){var n=new Blob([this.response],{type:"application/vnd.ms-excel"}),r=URL.createObjectURL(n),a=document.createElement("a");a.href=r;var o=new Date,i=o.getFullYear(),s=String(o.getMonth()+1);1===s.length&&(s="0"+s);var c=String(o.getDate());1===c.length&&(c="0"+c);var l=""+i+s+c,p=(App.whoAmI.abbreviation,l);return a.download="IHR Costing Tool - Costing Worksheet - "+p+".xlsx",document.body.appendChild(a),a.click(),void(t&&t(null))}t&&t(this.status)},App.whoAmI.staff_overhead_perc_str=Util.percentizeDec(App.whoAmI.staff_overhead_perc),n.send(JSON.stringify({exportType:"costingWorksheet",indicators:e,currencyCode:App.whoAmI.currency_iso,exchangeRate:App.getExchangeRate(),whoAmI:App.whoAmI,gbc:App.globalBaseCosts,gsm:App.globalStaffMultipliers,User:User}))},App.geoJson={},App.createLeafletMap=function(){App.mapConfig={divId:"leaflet-map",view:{coordinates:[20,0],zoom:2},url:"https://api.mapbox.com/styles/v1/jpecht/cj6qlfi5m3lg62rmz8svshi43/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoianBlY2h0IiwiYSI6ImNpdHhlMTc5NzAwczEydHFtbnZnankzNmEifQ.79pr8-kMwzRaEzUhvvgzsw",options:{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',maxZoom:8,minZoom:2,id:"mapbox.light",accessToken:"pk.eyJ1Ijoibmljb2xhaXZhc3F1ZXoiLCJhIjoiY2o2MWNlaWk3MG5ycTJ3bndmZWs4NWFyNSJ9.h0XBCKm965_UoB4oRS_3eA"},styles:{default:{stroke:!0,weight:0,fill:!0,color:"transparent"},active:{fillColor:"#ff7a7a"},selected:{fillColor:"#dd0000",weight:1,color:"#333"}}};var t=void 0,e=void 0,n="",r=function(){t=L.map(App.mapConfig.divId,{zoomSnap:.1}).setView(App.mapConfig.view.coordinates,App.mapConfig.view.zoom),L.tileLayer(App.mapConfig.url,App.mapConfig.options).addTo(t),(e=L.control({position:"topright"}).setPosition("topright")).onAdd=function(t){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},e.update=function(t){this._div.innerHTML=t&&t.name?"<p>"+t.name+"</p>":""}},a=function(t){var e=t.target;n!==e.feature.properties.iso_a2&&e.setStyle(App.mapConfig.styles.active)},o=function(t){t.target;n!==t.target.feature.properties.iso_a2&&(App.geoJson.resetStyle(t.target),e.update())},i=function(t){var e=t.target.feature.properties.iso_a2;if(e===n)return n="",App.geoJson.resetStyle(t.target),void(App.whoAmI={});n=e,App.geoJson.eachLayer(function(t){e===t.feature.properties.iso_a2?t.setStyle(App.mapConfig.styles.selected):App.geoJson.resetStyle(t)}),App.updateCountry(e)},s=function(t,e){e.on({mouseover:a,mouseout:o,click:i}),App.whoAmI.hasOwnProperty("abbreviation")&&App.whoAmI.abbreviation===e.feature.properties.iso_a2&&(e.setStyle(App.mapConfig.styles.selected),n=App.whoAmI.abbreviation)},c=function(){$.getJSON("data/custom.geo.json",function(e){App.geoJson=L.geoJson(e,{style:App.mapConfig.styles.default,onEachFeature:s}).addTo(t)}),e.addTo(t),e.setPosition("topright")};return setTimeout(function(){r(),c()},100),t},App.buildTabNavigation=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=e.split(".")[0],a=d3.select(t).selectAll(".block-link-capacities").data(App.jeeTree).enter().append("div").attr("class","block-link-capacities"),o=a.append("div").attr("class","block-link-capabilities-header").classed("active",function(t){return"Other"===t.name?t.active=!App.normalCcIds.includes(r):t.active=t.id===r}).on("click",function(t){var e=hasher.getHashAsArray(),n=t.capacities[0].id.replace(".","-");hasher.setHash(e[0]+"/"+n+"/1")});o.append("div").attr("class","block-link-cover"),o.append("svg").attr("class","chevron").attr("viewBox","0 0 24 24").classed("active",function(t){return t.active}).attr("src","img/chevron-right.png").append("path").attr("d","M8 5v14l11-7z"),o.append("span").text(function(t){return t.name});var i=a.append("div").style("display",function(t){return t.active?"block":"none"}).selectAll(".block-link").data(function(t){return t.capacities}).enter().append("div").attr("class","block-link").classed("active",function(t){return t.id===e}).on("click",function(t){var e=hasher.getHashAsArray(),n=t.id.replace(".","-");hasher.setHash(e[0]+"/"+n+"/1")});i.append("div").attr("class","block-link-title").html(function(t){return t.id.toUpperCase()+" - "+t.name}),i.append("div").attr("class","block-link-subtitle").classed("active",function(t){return t.id===e}).html(function(t){return n.displayCostingProgress?App.getNumIndicatorsCosted(t)+" of "+t.indicators.length:t.indicators.filter(function(t){return t.score}).length+" of "+t.indicators.length}),i.append("div").attr("class","block-link-cover")},App.initBackground=function(){},App.initContact=function(){},App.initCosting=function(t,e){function n(){$(".capacity-description-container").html(Routing.templates["capacity-description"]()),App.buildCapacityDescription(c),"Immunization"===p.name&&$(".capacity-tooltip-img").show().tooltipster({interactive:!0,content:'An alternative method to estimate vaccination costs is available using the <a href="http://www.avenirhealth.org/software-onehealth.php" target="_blank">OneHealth Tool</a>'})}function r(){function n(t,e){var n=w.append("div").style("display",function(t){return App.getNeededLineItems(t.line_items,u.score).filter(e).length?"block":"none"});n.append("div").attr("class","item-details-title").text(t);var r=n.append("div").attr("class","line-item-table-container").append("table").attr("class","line-item-table table table-condensed table-striped").append("tbody"),a=r.selectAll("tr").data(function(t){return App.getNeededLineItems(t.line_items,u.score).filter(e)}).enter().append("tr"),o=a.append("td");o.append("span").text(function(t){return t.name}),o.append("img").attr("class","line-item-description-button").attr("src","img/question-mark.png").each(function(t){var e='<div class="li-tooltip-content">';e+="<b>"+t.name+":</b> "+t.description,e+="</div>",$(this).tooltipster({interactive:!0,trigger:"click",content:e})}),a.append("td").text(function(t){return App.moneyFormatLong(t.cost)});var i=r.append("tr");return i.append("td").text("Total"),i.append("td").text(function(t){var n=App.getNeededLineItems(t.line_items,u.score).filter(e);return App.moneyFormatLong(d3.sum(n,function(t){return t.cost}))}),n}o();var r=d3.select(".indicator-container").selectAll(".indicator-slot-container").data(p.indicators).enter().append("div").attr("class","indicator-slot-container"),s=r.append("div").attr("class","indicator-slot").classed("active",function(t){return t.id===l}).classed("empty",function(t){return void 0===App.getIndicatorScore(t.id)}).on("click",function(e,n){hasher.setHash("costs/"+t+"/"+(n+1))});s.append("svg").attr("class","chevron").classed("active",function(t){return t.id===l}).attr("viewBox","0 0 24 24").append("path").attr("d","M8 5v14l11-7z"),s.append("div").attr("class","indicator-id").text(function(t){return t.id.toUpperCase()+" - "}),s.append("div").attr("class","indicator-name").text(function(t){return Util.truncateText(t.name)});s.append("div").attr("class","indicator-score").html(function(t){var e=App.getIndicatorScore(t.id);if(!e)return"<i>No Score</i>";var n="step"===User.targetScoreType?e+1:User.targetScore,r='<img class="rp-score" src="img/rp-'+e+'.png" alt='+e+" />";return n>e&&e<4&&(r+='<span> to </span><img class="rp-score" src="img/rp-'+n+'.png" alt='+n+" />"),r});$(".indicator-description").html(l.toUpperCase()+" - "+u.name);var c=r.filter(function(t){return t.id===l});if(!u.score)return c.append("div").attr("class","no-score-container").html("This indicator has not been <b>scored</b> yet. Click <u>here</u> to enter a score.").on("click",function(){hasher.setHash("scores/"+t+"/"+e)}),void $(".action-description-container").hide();if(!d.length){var f="There are no actions needed to increase the current score for this indicator";return 4===u.score?f="Costs to increase from score <b>4</b> to <b>5</b> are highly country-specific and are not included in the IHR Costing Tool.":5===u.score&&(f="Indicators with a score of <b>5</b> do not require costing (no new actions required)."),c.append("div").attr("class","no-actions-container").html(f),void $(".action-description-container").hide()}var h=c.selectAll(".action-slot").data(d).enter().append("div").attr("class","action-slot-container"),m=h.append("div").attr("class","action-slot").attr("action-id",function(t){return t.id}).on("click",function(t){return a(t)});m.append("svg").attr("class","chevron").attr("viewBox","0 0 24 24").append("path").attr("d","M8 5v14l11-7z"),m.append("div").attr("class","action-name").text(function(t){return t.id.toUpperCase()+" - "+t.name}),m.append("div").attr("class","action-progress"),i();var g=h.append("div").attr("class","item-block-container").each(function(t){return t.itemShownIndex=0});g.append("div").attr("class","item-block-progress-text").text(function(t){return"Item 1 of "+App.getNeededInputs(t.inputs,u.score).length}),g.append("div").attr("class","item-block-arrow-prev item-block-arrow").style("display","none").on("click",function(t){var e=$(this).parent();e.find(".item-block[item-index="+t.itemShownIndex+"]").animate({left:"800px"}),t.itemShownIndex--,e.find(".item-block[item-index="+t.itemShownIndex+"]").animate({left:"155px"});var n=App.getNeededInputs(t.inputs,u.score).length;e.find(".item-block-progress-text").text("Item "+(t.itemShownIndex+1)+" of "+n),0===t.itemShownIndex&&$(this).hide(),e.find(".item-block-arrow-next").show()}).append("img").attr("src","img/prev-arrow.png").attr("alt","Previous"),g.append("div").attr("class","item-block-arrow-next item-block-arrow").style("display",function(t){return App.getNeededInputs(t.inputs,u.score).length>1?"block":"none"}).on("click",function(t){var e=$(this).parent();e.find(".item-block[item-index="+t.itemShownIndex+"]").animate({left:"-800px"}),t.itemShownIndex++,e.find(".item-block[item-index="+t.itemShownIndex+"]").animate({left:"155px"});var n=App.getNeededInputs(t.inputs,u.score).length;e.find(".item-block-progress-text").text("Item "+(t.itemShownIndex+1)+" of "+n),t.itemShownIndex+1>=n&&$(this).hide(),e.find(".item-block-arrow-prev").show()}).append("img").attr("src","img/next-arrow.png").attr("alt","Next");var v=g.selectAll(".item-block").data(function(t){return App.getNeededInputs(t.inputs,u.score)}).enter().append("div").attr("class","item-block").attr("item-index",function(t,e){return e}).style("left",function(t,e){return 0===e?"155px":"800px"}).append("div").attr("class","item-shell"),b=v.append("div").attr("class","front").append("div").attr("class","item-front-shell"),A=v.append("div").attr("class","back");b.append("div").attr("class","item-title-container").append("div").attr("class","item-title").text(function(t){return t.name});var y=b.append("div").attr("class","item-startup-cost-container");y.append("div").attr("class","item-cost-name").text("Startup Cost: "),y.append("input").attr("class","startup-cost-input form-control").attr("value",function(t){var e=t.isCustomCost?t.customStartupCost:t.startupCost+t.capitalCost;return Util.comma(e)}).style("color",function(t){return t.costed?"black":"#999"}).on("change",function(t){t.isCustomCost=!0,t.customStartupCost=Util.getInputNumVal(this),t.customRecurringCost||(t.customRecurringCost=t.recurringCost),t.costed=!0;var e=$(this).closest(".item-block");e.find("input").css("color","black"),e.find(".item-save-button").removeClass("primary"),App.updateAllCosts()}),y.append("div").attr("class","item-cost-currency").text(App.whoAmI.currency_iso),y.append("img").attr("class","item-cost-tooltip-img").attr("src","img/question-mark.png").each(function(t){$(this).tooltipster({content:App.definitions.startupCost})});var C=b.append("div").attr("class","item-recurring-cost-container");C.append("div").attr("class","item-cost-name").text("Recurring Cost: "),C.append("input").attr("class","recurring-cost-input form-control").attr("value",function(t){var e=t.isCustomCost?t.customRecurringCost:t.recurringCost;return Util.comma(e)}).style("color",function(t){return t.costed?"black":"#999"}).on("change",function(t){t.isCustomCost=!0,t.customRecurringCost=Util.getInputNumVal(this),t.customStartupCost||(t.customStartupCost=t.startupCost+t.capitalCost),t.costed=!0;var e=$(this).closest(".item-block");e.find("input").css("color","black"),e.find(".item-save-button").removeClass("primary"),App.updateAllCosts()}),C.append("div").attr("class","item-cost-currency").text(App.whoAmI.currency_iso+"/yr"),C.append("img").attr("class","item-cost-tooltip-img").attr("src","img/question-mark.png").each(function(t){$(this).tooltipster({content:App.definitions.recurringCost})}),b.append("div").attr("class","item-save-cost-text").text("Costs Saved!");var x=b.append("div").attr("class","item-footer");x.append("div").attr("class","item-save-button").classed("primary",function(t){return!t.costed}).text("Save Costs").on("click",function(t){if(!t.costed){t.costed=!0,$(this).removeClass("primary").closest(".item-block").find("input").css("color","black"),i();var e=App.getNumIndicatorsCosted(p);d3.select(".block-link-subtitle.active").text(e+" of "+p.indicators.length)}var n=$(this).closest(".item-block").find(".item-save-cost-text");n.show(),setTimeout(function(){n.fadeOut(800)},1e3),App.updateAllCosts()}),x.append("div").attr("class","item-view-details-button").text("View Details").on("click",function(){$(this).closest(".item-block").toggleClass("active")});var w=A.append("div").attr("class","item-details-container");n("Default Startup/Capital Costs",function(t){return"start-up"===t.line_item_type||"capital"===t.line_item_type}),n("Default Recurring Costs",function(t){return"recurring"===t.line_item_type});d3.selectAll(".item-details-container").each(function(t){var e=App.getNeededLineItems(t.line_items,u.score),n=e.filter(function(t){return"recurring"===t.line_item_type});n.length&&n.length<e.length&&d3.select(this).selectAll(".line-item-table-container").style("height","57px")}),w.append("div").attr("class","item-footer").append("div").attr("class","item-return-to-front-button").text("Return to Edit Cost").on("click",function(){$(this).closest(".item-block").toggleClass("active")})}function a(t){d3.selectAll(".action-slot-container, .action-slot").classed("active",function(e){return e.id===t.id}).select(".chevron").classed("active",function(e){return e.id===t.id});$(".action-slot-container:not(.active) .item-block-container").css("height","340px").css("min-height","0px").slideUp(400,function(){$(this).css("height","auto").css("min-height","340px")}),$(".action-slot-container.active .item-block-container").css("height","340px").css("min-height","0px").slideDown(400,function(){$(this).css("height","auto").css("min-height","340px")}),d.length?$(".action-description").html(t.id.toUpperCase()+" - "+t.name):$(".action-description").html("<i>No actions need to be taken to increase the score for this indicator</i>")}function o(){var t=p.indicators.length,e=App.getNumIndicatorsCosted(p);d3.select(".indicator-progress").text("Review costs for each indicator ("+e+" of "+t+"):")}function i(){d3.selectAll(".action-progress").text(function(t){var e=App.getNeededInputs(t.inputs,u.score);return e.filter(function(t){return t.costed}).length+" of "+e.length+" items costed"})}function s(){d3.select(".next-cost").on("click",function(){var t=App.getNextIndicator(c,l).id;t||hasher.setHash("results");var e=t.lastIndexOf("."),n=t.slice(0,e).replace(".","-"),r=t.slice(e+1);hasher.setHash("costs/"+n+"/"+r)}),d3.select(".previous-cost").on("click",function(){var t=App.getPrevIndicator(c,l).id;if(t){var e=t.lastIndexOf("."),n=t.slice(0,e).replace(".","-"),r=t.slice(e+1);hasher.setHash("costs/"+n+"/"+r)}})}var c=Util.getIndicatorId(t),l=Util.getIndicatorId(t+"-"+e),p=App.getCapacity(c),u=App.getIndicator(l),d=App.getNeededActions(u);$(".go-to-results-button").click(function(){return hasher.setHash("results")}),App.buildTabNavigation(".block-link-container",c,{displayCostingProgress:!0}),n(),r(),d.length&&a(d[0]),s()},App.initCostsInstructions=function(){$(".target-score-option").click(function(){d3.selectAll(".target-score-option input").property("checked",!1),d3.select(this).select("input").property("checked",!0);var t=d3.select(this).attr("ind");if(User.targetScoreType=t,"target"===t){var e=$(this).find("select").val();User.targetScore=e}App.updateAllCosts()}),$(".target-score-select").on("change",function(){var t=$(this).val();User.targetScore=t,App.updateAllCosts(),4==+t?$(".color-bar").css("background-color","#87c764"):$(".color-bar").css("background-color","#ede929")}),$(".btn-blank-template").on("click",function(){App.exportCostingWorksheet()}),$(".costs-instructions-start").click(function(){hasher.setHash("costs")})},App.initCountry=function(){function t(t){App.geoJson.eachLayer(function(e){e.feature.properties.iso_a2===t?e.setStyle(App.mapConfig.styles.selected):App.geoJson.resetStyle(e)})}function e(t){if(""!==t.trim()){var e=new Fuse(App.countryParams,{threshold:.3,distance:1e5,keys:["abbreviation","name","currency_iso"]}).search(t);if(a.show(),0===e.length)a.find(".live-search-no-results-text").show(),a.find(".live-search-results-contents").hide();else{a.find(".live-search-no-results-text").hide(),a.find(".live-search-results-contents").show();var n=d3.select(a[0]).select(".live-search-results-contents").selectAll(".live-search-results-box").data(e.slice(0,4));n.exit().remove();var r=n.enter().append("div").attr("class","live-search-results-box");r.append("div").attr("class","live-search-results-title"),r.append("div").attr("class","live-search-results-subtitle"),(n=n.merge(r).attr("code",function(t){return t.abbreviation}).on("mousedown",function(t){$(".country-search-input").val(""),App.updateCountry(t.abbreviation)})).select(".live-search-results-title").text(function(t){return t.name}),n.select(".live-search-results-subtitle").text(function(t){return"Population: "+Util.comma(t.multipliers.population)})}}else a.hide()}App.createLeafletMap();var n=App.countryParams.slice(0);Util.sortByKey(n,"name"),n.unshift({name:"--- choose a country ---",abbreviation:""}),Util.populateSelect(".country-dropdown",n,{nameKey:"name",valKey:"abbreviation"}),$(".country-dropdown").on("change",function(){App.updateCountry($(this).val())}),App.whoAmI.abbreviation&&$(".country-dropdown").val(App.whoAmI.abbreviation);var r=void 0,a=$(".live-search-results-container");$(".country-search-input").on("focus",function(){e($(this).val())}).on("blur",function(){clearTimeout(r),a.hide()}).on("keyup",function(t){clearTimeout(r);var n=$(this).val();13===t.which?e(n):r=setTimeout(function(){e(n)},250)}),App.updateCountry=function(e){$(".country-dropdown").val(e),t(e);var n=App.countryParams.find(function(t){return t.abbreviation===e});App.whoAmI=JSON.parse(JSON.stringify(n)),App.updateAllCosts()},$(".go-to-assessment-button").click(function(){return hasher.setHash("overview")})},App.initHome=function(){$(".enter-site").click(function(){return hasher.setHash("country")})},App.initOverview=function(){$(".next-button").click(function(){hasher.setHash("scores/")}),$(".jee-tool-img").tooltipster({trigger:"hover",content:"The <b>JEE Technology Tool</b> is a separate, open-access tool developed by the Global Health Security Agenda Private Sector Roundtable Technology and Analytics Working Group and powered by Qlik Technologies."}),$(".btn-prior-session").on("click",function(){$(".input-prior-session").trigger("click")}),$(".input-prior-session").on("change",function(){if("files"in this){if(!this.files.length)return;var t=this.files[0];if(".ihr"!==t.name.slice(t.name.length-4))return void noty({timeout:5e3,text:"<b>Please select a file with a file type extension of <i>.ihr</i>"});var e=new FileReader;e.onload=function(t){NProgress.start(),App.loadSessionData(t.target.result)?(App.updateAllCosts(),noty({timeout:4e3,type:"success",text:"<b>Upload Successful!</b><br>Your previous session has been restored."})):noty({timeout:5e3,text:"<b>Error!</b><br>There was an error uploading your previous session."}),NProgress.done()},e.readAsBinaryString(t)}}),$(".btn-blank-template").on("click",function(){NProgress.start(),App.exportCostingWorksheet(function(){NProgress.done()})}),$(".btn-score-file").on("click",function(){$(".input-score-file").trigger("click")}),$(".input-score-file").on("change",function(){if("files"in this){if(!this.files.length)return;var t=this.files[0];if(".xlsx"!==t.name.slice(t.name.length-4))return void noty({timeout:5e3,text:"<b>Please select a file with a file type extension of <i>.xlsx</i>"});var e=new FileReader;e.onload=function(t){NProgress.start(),App.loadQlickScoreData(t.target.result)?(App.updateAllCosts(),noty({timeout:4e3,type:"success",text:"<b>Upload Successful!</b><br>Score data has been uploaded."})):noty({timeout:5e3,text:"<b>Error!</b><br>There was an error uploading the score data. Please check the file format."}),NProgress.done()},e.readAsBinaryString(t)}})},App.initResults=function(){function t(){var t=[],e=$(".category-select").val();return"capacity"===d?b.forEach(function(n){var r=Object.assign({},n),a=C.filter(function(t){return t.id===n.id&&e.includes(t.category_tag)});r.startupCost=d3.sum(a,function(t){return t.startupCost}),r.capitalCost=d3.sum(a,function(t){return t.capitalCost}),r.recurringCost=d3.sum(a,function(t){return t.recurringCost}),t.push(r)}):"category"===d&&(t=(t=C).filter(function(t){return e.includes(t.category_tag)})),t.filter(function(t){return m.includes(t.capId)})}function e(){return"capacity"===d?function(t){return t.capId.toUpperCase()}:"category"===d?function(t){return t.category_tag}:function(t){return 0}}function n(){return"total"===f?function(t){return t.startupCost+t.capitalCost+h*t.recurringCost}:"startup"===f?function(t){return t.startupCost}:"capital"===f?function(t){return t.capitalCost}:"recurring"===f?function(t){return t.recurringCost}:function(t){return 0}}function r(t){return n()(t)}function a(){T.update(t(),e(),n()),o(),i()}function o(){var t="";"capacity"===d?t="Capacity":"category"===d&&(t="Function"),T.updateXAxisLabel(t)}function i(){var t="";t="total"===f?h+"-Year":f.charAt(0).toUpperCase()+f.slice(1),T.updateYAxisLabel(t+" Cost")}function s(t){m=t.capacities.map(function(t){return t.id}),p(),a();var e=$(".chart-section").position().top+110;$("html, body").animate({scrollTop:e},600)}function c(){l(".total-cost-number",d3.sum(App.jeeTree,function(t){return r(t)})),d3.selectAll(".summary-text-box .big-number").each(function(t){g.find(function(e){return e.name===t.name})?l(this,r(t)):d3.select(this).text("-")})}function l(t,e){var n=d3.select(t);isNaN(Util.strToFloat(n.text()))&&n.text(App.moneyFormat(1e6)),n.transition().duration(300).tween("text",function(t){var n=d3.select(this),r=d3.interpolateNumber(Util.strToFloat(n.text()),e);return function(t){return n.text(App.moneyFormat(r(t)))}})}function p(){var t=[],e=[];App.jeeTree.forEach(function(n){for(var r=!1,a=n.capacities.map(function(t){return t.id}),o=0;o<m.length;o++)if(a.includes(m[o])){r=!0,t.push(n.id);break}r||e.push(n.id)}),$(".cc-select").multiselect("select",t,!1).multiselect("deselect",e,!1);var n=v.filter(function(t){return!m.includes(t.id)}).map(function(t){return t.id});$(".capacity-select").multiselect("select",m,!1).multiselect("deselect",n,!1)}function u(t,e,n){var r=d3.select(t);r.append("thead").append("tr").selectAll("th").data(U).enter().append("th").attr("class",function(t){return t.className||""}).text(function(t){return t.name.replace("[level]",n)});var a=r.append("tbody");a.selectAll("tr").data(e).enter().append("tr").selectAll("td").data(function(t){return U.map(function(e){return{rowData:t,colData:e}})}).enter().append("td").attr("class",function(t){return t.colData.className||""}).text(function(t){return(t.colData.format||function(t){return t})(t.colData.getValue(t.rowData))}),a.append("tr").attr("class","total-row").selectAll("td").data(U).enter().append("td").attr("class","cost").text(function(t){return"cost"===t.className?App.moneyFormatLong(d3.sum(e,t.getValue)):""})}var d="capacity",f="total",h=1,m=[],g=[],v=[],b=[],A=[],y=[],C=[],x={};if(App.jeeTree.forEach(function(t){var e=!1;t.capacities.forEach(function(n){var r=!1;n.indicators.forEach(function(a){if(App.isIndicatorComplete(a)){e=!0,r=!0;var o=Object.assign({},a);o.ccId=t.id,o.capId=n.id,b.push(o),o.costByTag={},App.getNeededActions(o).forEach(function(t){A.push(Object.assign({},t)),App.getNeededInputs(t.inputs,o.score).forEach(function(t){var e={},n=App.getNeededLineItems(t.line_items,o.score),r=d3.sum(n,function(t){return t.cost});n.forEach(function(t){var n=t.function_tag;e[n]||(e[n]=0),e[n]+=r?t.cost/r:1});for(var a in e)o.costByTag[a]||(o.costByTag[a]={startupCost:0,capitalCost:0,recurringCost:0}),t.isCustomCost?(o.costByTag[a].startupCost+=Math.round(e[a]*t.customStartupCost),o.costByTag[a].recurringCost+=Math.round(e[a]*t.customRecurringCost)):(o.costByTag[a].startupCost+=Math.round(e[a]*t.startupCost),o.costByTag[a].capitalCost+=Math.round(e[a]*t.capitalCost),o.costByTag[a].recurringCost+=Math.round(e[a]*t.recurringCost))})});for(var i in o.costByTag)if(i){var s=Object.assign({},o),c=o.costByTag[i];0===i.indexOf("Planning")||0===i.indexOf("Analysis")?s.category_tag=i.split(" ")[0]:s.category_tag=i;for(var l in c)s[l]=c[l];C.push(s),x[i]||(x[i]={startupCost:0,capitalCost:0,recurringCost:0});for(var p in c)x[i][p]+=c[p]}}}),r&&v.push(n)}),e&&g.push(t)}),!g.length)return $(".results-content").hide(),void $(".results-empty-content").on("click",function(){return hasher.setHash("scores/p-1/1")}).show();y=_.unique(C.map(function(t){return t.category_tag})),$(".num-costed-indicators").text(b.length),$(".num-costed-capacities").text(v.length),$(".view-table-button").on("click",function(){var t=$(this);t.toggleClass("table-view");var e=t.hasClass("table-view");t.text(e?"View Charts":"View Data Table"),$(".results-main-content, .results-table-content").slideToggle()}),$(".view-export-button").on("click",function(){var t=$(this);if(t.toggleClass("export-view"),t.hasClass("export-view"))$(".results-instructions, .results-main-content, .results-table-content").slideUp(),$(".view-table-button").hide(),t.html("&laquo; Back to Results");else{var e=$(".view-table-button").hasClass("table-view");$(".results-instructions").slideDown(),e?$(".results-table-content").slideDown():$(".results-main-content").slideDown(),$(".view-table-button").show(),t.html("Export Data")}}),$(".cost-type-row button").each(function(){var t=$(this).attr("value");$(this).tooltipster({content:App.definitions[t+"Cost"]})}).on("click",function(){f=$(this).attr("value"),$('.cost-type-row button[value="'+f+'"]').addClass("active").siblings().removeClass("active"),"total"===f?$(".cost-duration-row").slideDown():$(".cost-duration-row").slideUp(),c(),i(),T.update(null,null,n())}),$(".cost-duration-row button").on("click",function(){h=+$(this).attr("value"),$('.cost-duration-row button[value="'+h+'"]').addClass("active").siblings().removeClass("active"),c(),i(),T.update(null,null,n())}),$(".view-cost-by-box .filter-row").on("click",function(){var t=$(this);t.find("input").prop("checked",!0),t.siblings(".filter-row").find("input").prop("checked",!1),d=t.attr("value"),a()}),$(".reset-button").on("click",function(){a()});var w=App.getAverageCurrentScore(b),k=App.getAverageTargetScore(b);Charts.buildProgressChart(".progress-chart-overall",[w,k]);var I=d3.select(".summary-text-section").selectAll(".summary-text-box").data(App.jeeTree).enter().append("div").attr("class","summary-text-box").each(function(t){t.isEmpty=!g.find(function(e){return e.name===t.name}),t.isEmpty&&$(this).tooltipster({interactive:!0,content:"There are <b>no scored/costed indicators</b> for this core element. Click <span onclick=\"hasher.setHash('scores/"+t.id+"-1/1')\">here</span> to go to the scoring page for this core element."})}).on("click",function(t){t.isEmpty||s(t)});I.append("div").attr("class",function(t){if(!t.isEmpty){var e=[];t.capacities.forEach(function(t){e=e.concat(t.indicators)});var n=App.getAverageTargetScore(e),r="green";return n<2?r="red":n<4&&(r="yellow"),"summary-text-box-veil "+r}return"summary-text-box-veil"});var S=I.append("div").attr("class","summary-text-box-content");S.append("div").attr("class","big-number-text").html(function(t){return t.name+" Cost"}),S.append("div").attr("class","big-number"),d3.select(".total-cost-number").text(App.moneyFormat(1e6));var T=Charts.buildCostChart(".cost-chart-container");Util.populateSelect(".cc-select",App.jeeTree,{nameKey:"name",valKey:"id",selected:!0}),Util.populateSelect(".capacity-select",v,{nameKey:function(t){return t.id.toUpperCase()+" - "+t.name},valKey:"id",selected:!0}),Util.populateSelect(".category-select",y,{selected:!0}),$(".cc-select").multiselect({includeSelectAllOption:!0,numberDisplayed:1,buttonClass:"btn btn-secondary",onChange:function(t,e){var n=App.jeeTree.find(function(e){return e.id===t.val()}).capacities.map(function(t){return t.id});e?n.forEach(function(t){m.includes(t)||m.push(t)}):m=m.filter(function(t){return!n.includes(t)}),p(),a()},onSelectAll:function(){m=v.map(function(t){return t.id}),p(),a()},onDeselectAll:function(){m=[],p(),a()}}),$(".capacity-select").multiselect({includeSelectAllOption:!0,numberDisplayed:0,buttonClass:"btn btn-secondary",onChange:function(t,e){var n=t.val();e?m.includes(n)||m.push(n):m=m.filter(function(t){return t!==n}),p(),a()},onSelectAll:function(){m=v.map(function(t){return t.id}),p(),a()},onDeselectAll:function(){m=[],p(),a()}}),$(".category-select").multiselect({includeSelectAllOption:!0,numberDisplayed:0,buttonClass:"btn btn-secondary",onChange:function(t,e){return a()},onSelectAll:function(){return a()},onDeselectAll:function(){return a()}}),m=v.map(function(t){return t.id}),p(),c(),a(),$(".table-tab-container button").on("click",function(){$(this).addClass("active").siblings().removeClass("active");var t=$(this).val();$(".table-container").slideUp(),$("."+t+"-table-container").slideDown()});var U=[{name:"[level] ID",getValue:function(t){return t.id.toUpperCase()}},{name:"[level] Name",getValue:function(t){return t.name}},{name:"Startup Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.startupCost}},{name:"Capital Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.capitalCost}},{name:"Recurring Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.recurringCost}},{name:"1-Year Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.startupCost+t.capitalCost+t.recurringCost}},{name:"3-Year Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.startupCost+t.capitalCost+3*t.recurringCost}},{name:"5-Year Cost",className:"cost",format:App.moneyFormatLong,getValue:function(t){return t.startupCost+t.capitalCost+5*t.recurringCost}}];u(".core-table",g,"Core Element"),u(".capacity-table",v,"Capacity"),u(".indicator-table",b,"Indicator"),u(".action-table",A,"Action"),$(".capacity-table-container").show(),$(".export-data-button").on("click",function(){NProgress.start(),App.exportLineItems(function(t){t&&noty({text:"<b>Warning!</b><br>There was an error exporting the detailed report. Please contact the administrators of the tool."}),NProgress.done()})}),$(".export-session-button").on("click",function(){var t=App.getSessionData(),e=new Date,n=e.getFullYear(),r=String(e.getMonth()+1);1===r.length&&(r="0"+r);var a=String(e.getDate());1===a.length&&(a="0"+a);var o=""+n+r+a,i=""+App.whoAmI.abbreviation+o;App.downloadText(i,t)}),$(".export-empty-template-button").on("click",function(){NProgress.start(),App.exportCostingWorksheet(function(){NProgress.done()})})},App.initScores=function(t,e){function n(){$(".capacity-description-container").html(Routing.templates["capacity-description"]()),App.buildCapacityDescription(s),"Immunization"===l.name&&$(".capacity-tooltip-img").show().tooltipster({interactive:!0,content:'An alternative method to estimate vaccination costs is available using the <a href="http://www.avenirhealth.org/software-onehealth.php" target="_blank">OneHealth Tool</a>'})}function r(){o();var e=d3.select(".indicator-container").selectAll(".indicator-slot").data(l.indicators).enter().append("div").attr("class","indicator-slot").classed("active",function(t){return t.id===c}).classed("empty",function(t){return void 0===App.getIndicatorScore(t.id)}).on("click",function(e,n){hasher.setHash("scores/"+t+"/"+(n+1))});e.append("div").attr("class","indicator-name").text(function(t){return t.id.toUpperCase()+" - "+Util.truncateText(t.name)});var n=e.append("div").attr("class","indicator-score");n.append("span").attr("class","score-none").style("display",function(t){return App.getIndicatorScore(t.id)?"none":"inline"}).html("<i>No Score</i>");for(var r=1;r<=5;r++)!function(t){n.append("img").attr("class","rp-score").attr("src","img/rp-"+t+".png").attr("alt",t).attr("score",t).style("display",function(e){return+App.getIndicatorScore(e.id)===t?"inline":"none"})}(r);$(".indicator-description").html(c.toUpperCase()+" - "+p.name)}function a(){var t=d3.select(".score-picker-table tbody").selectAll("tr").data(d3.range(1,6)).enter().append("tr").attr("class","score-row").classed("active",function(t){return t===p.score}).on("click",function(t){var e=d3.select(this),n=e.select("input").property("checked"),r=n?void 0:t,a=d3.selectAll(".score-row").classed("active",!1);a.select("input").property("checked",!1),a.select(".score-description-cell").text(function(t){var e=p.score_descriptions[t];return e.length>300?e.slice(0,300)+"...":e}),e.classed("active",!n),e.select("input").property("checked",!n),d3.select(".score-row.active .score-description-cell").text(function(t){return p.score_descriptions[t]}),App.setIndicatorScore(c,r);var i=d3.select(".indicator-slot.active .indicator-score");r?(i.select(".score-none").style("display","none"),i.selectAll("img").style("display",function(){return+$(this).attr("score")==+t?"inline":"none"})):(i.select(".score-none").style("display","inline"),i.selectAll("img").style("display","none")),o()});t.append("td").append("input").attr("type","radio").property("checked",function(t){return t===p.score}).on("click",function(){$(this).prop("checked",!$(this).prop("checked"))});var e=t.append("td");e.append("img").attr("class","rp-score-table-img rp-score").attr("src",function(t){return"img/rp-"+t+".png"}),e.append("span").attr("class","score-label").text(function(t){return App.scoreLabels[t]}),t.append("td").attr("class","score-description-cell").text(function(t){var e=p.score_descriptions[t];return e.length>300?e.slice(0,300)+"...":e}),t.append("td")}function o(){var t=l.indicators.length,e=l.indicators.filter(function(t){return t.score}).length;d3.select(".indicator-progress").text("Select a score for each indicator ("+e+" of "+t+"):"),d3.select(".block-link-subtitle.active").text(e+" of "+t)}function i(){d3.select(".next-score").on("click",function(){var t=App.getNextIndicator(s,c).id;t||hasher.setHash("costsinstructions");var e=t.lastIndexOf("."),n=t.slice(0,e).replace(".","-"),r=t.slice(e+1);hasher.setHash("scores/"+n+"/"+r)}),d3.select(".previous-score").on("click",function(){var t=App.getPrevIndicator(s,c).id;if(t){var e=t.lastIndexOf("."),n=t.slice(0,e).replace(".","-"),r=t.slice(e+1);hasher.setHash("scores/"+n+"/"+r)}}),$(".go-to-costing-button").click(function(){return hasher.setHash("costsinstructions")})}var s=Util.getIndicatorId(t).toLowerCase(),c=Util.getIndicatorId(t+"-"+e).toLowerCase(),l=App.getCapacity(s),p=App.getIndicator(c);App.prevHash||(App.prevHash="");var u=App.prevHash.split("/");"scores"!==u[0]||u[1],App.prevHash=hasher.getHash(),App.buildTabNavigation(".block-link-container",s,{includeScoreBars:!0}),n(),r(),a(),i()},function(){var t="#fff3cd",e=[{abbr:"population",name:"Population and Currency"},{abbr:"country-details",name:"Country Details"},{abbr:"default-costs",name:"Cost Assumptions (optional)",children:["personnel","technology","printing","meetings"]},{abbr:"personnel",tabName:"Personnel compensation",name:"Personnel Compensation",level:1},{abbr:"technology",name:"Technology and Infrastructure",level:1},{abbr:"printing",name:"Printing",level:1},{abbr:"meetings",name:"Meetings",level:1}];App.initWho=function(t){if("default-costs"!==t){switch(t){case"population":n();break;case"country-details":r();break;default:a(t)}var o=d3.select(".block-link-container").selectAll(".block-link").data(e).enter().append("div").attr("class","block-link").attr("level",function(t){return t.level}).classed("active",function(e){return e.children?e.children.includes(t):t===e.abbr}).style("display",function(e){return e.level?["personnel","technology","printing","meetings"].includes(t)?"inline-block":"none":"inline-block"}).on("click",function(t){return hasher.setHash("costs/"+t.abbr)});o.append("svg").attr("class","chevron").classed("active",function(t){return"default-costs"===t.abbr}).attr("viewBox","0 0 24 24").attr("src","img/chevron-right.png").style("display",function(e){return e.children&&e.children.includes(t)?"inline":t===e.abbr?"inline":"none"}).append("path").attr("d","M8 5v14l11-7z"),o.append("div").attr("class","block-link-title").html(function(t){return t.name}),o.append("div").attr("class","block-link-cover"),$(".defn").tooltipster({functionInit:function(t,e){var n=t._$origin.attr("defn");if("pop"===n){var r="This is the estimated total population for the country chosen. The number can be changed using the edit box below";return t.content(r),r}if("geo"===n){var a="This is the estimated total population for the country chosen. The number can be changed using the edit box below";return t.content(a),a}if("phi"===n){var o="This is the estimated total population for the country chosen. The number can be changed using the edit box below";return t.content(o),o}}})}else hasher.setHash("costs/personnel")};var n=function(){function e(){var e=Math.round(App.whoAmI.multipliers.population)===Math.round(n);$(".population-input").css("background-color",e?"#fff":t),e?$(".default-pop-text").slideUp():$(".default-pop-text").text("Default: "+Util.comma(n)).slideDown()}$(".population-block").slideDown();var n=App.countryParams.find(function(t){return t.name===App.whoAmI.name}).multipliers.population;$(".population-input").val(Util.comma(n)).on("change",function(){App.whoAmI.multipliers.population=Util.getInputNumVal(this),e(),App.updateAllCosts()});var r=[];for(var a in App.currencies)r.push({name:App.currencies[a].name,code:App.currencies[a].iso.code});Util.sortByKey(r,"name"),Util.populateSelect(".currency-select",r,{nameKey:"name",valKey:"code"}),$(".currency-select").val(App.whoAmI.currency_iso).on("change",function(){App.whoAmI.currency_iso=$(this).val(),App.updateAllCosts()}),$(".next-button").click(function(){return hasher.setHash("costs/country-details")})},r=function(){$(".country-details-block").slideDown();var t=[{nameAttr:"intermediate_1_area_name",valueAttr:"intermediate_1_area_count",description:"Intermediate (e.g., province, district)",nameValues:["Province","Municipality","District","State"]},{nameAttr:"intermediate_2_area_name",valueAttr:"intermediate_2_area_count",description:"Intermediate 2 (optional)",nameValues:["Province","Municipality","District","State","County"]},{nameAttr:"local_area_name",valueAttr:"local_area_count",description:"Local (e.g., county, city)",nameValues:["Barangay","City","Constituency","County","District"]}],e=d3.select(".geo-division-table tbody").selectAll("tr").data(t).enter().append("tr");e.append("td").text(function(t){return t.description+":"}),e.append("td").append("select").attr("class","form-control").each(function(t){var e=["-- select one --"].concat(t.nameValues);Util.populateSelect(this,e);var n=App.whoAmI[t.nameAttr];n&&$(this).val(n)}).on("change",function(t){var e=$(this).val();App.whoAmI[t.nameAttr]="-- select one --"===e?"":e}),e.append("td").append("input").attr("class","form-control").attr("value",function(t){return Util.comma(App.whoAmI.multipliers[t.valueAttr])}).on("change",function(t){App.whoAmI.multipliers[t.valueAttr]=Util.getInputNumVal(this),App.updateAllCosts()});var n=[{name:"central_hospitals_count",description:"Number of health care facilities in the country",unit:"health care facilities / country"},{name:"central_chw_count",description:"Number of community health workers in the country",unit:"community health workers / country"}],r=d3.select(".ph-table tbody").selectAll("tr").data(n).enter().append("tr");r.append("td").text(function(t){return t.description+":"});var a=r.append("td");a.append("input").attr("class","form-control").attr("value",function(t){return t.defaultValue=App.whoAmI.multipliers[t.name],Util.comma(t.defaultValue)}).on("change",function(t){App.whoAmI.multipliers[t.name]=Util.getInputNumVal(this),App.updateAllCosts()}),a.append("span").text(function(t){return t.unit}),$(".next-button").click(function(){return hasher.setHash("costs/personnel")}),$(".proceed-button").click(function(){return hasher.setHash("costs/p-1/1")})},a=function(n){function r(e,n){var r=d3.select(n),o=!0,i="Default: ";if(e.indexOf("gbc")>-1){if("gbc.overhead"===e)o=.6===App.whoAmI.staff_overhead_perc,i+="60";else if(null!==e){var s=App.globalBaseCosts.find(function(t){return t.id===e});o=Math.round(s.default_cost)===Math.round(s.cost),i+=Util.comma(s.default_cost*a)}}else{var c=App.globalStaffMultipliers.find(function(t){return t.id===e});o=c.default_count===c.count,i+=Util.comma(c.default_count)}r.style("background-color",function(){return o?"#fff":t});var l=$(d3.select(r.node().parentNode).select(".dv-default-text").node());o?l.slideUp():l.text(i).slideDown()}$(".default-costs-block").slideDown();var a=App.getExchangeRate(),o=App.globalBaseCosts.filter(function(t){if(!t.show_on_dv)return!1;var r=e.find(function(t){return t.abbr===n});return r.tabName?t.tab_name===r.tabName:t.tab_name===r.name});if("personnel"===n&&o.push({cost:.6,cost_unit:"% per year",description:"Additional amount that will be budgeted for employee overhead expenses, as a percentage of the employee's annual salary",id:"gbc.overhead",name:"Overhead percentage",tab_name:"Personnel compensation",subheading_name:"Salaries"}),"technology"===n&&o.push({type:"radio",values:["Buy","Lease"],description:"Choice of either buying or leasing facility space",name:"Buy or lease facility space",tab_name:"Technology and Infrastructure",subheading_name:"Infrastructure"}),"meetings"===n)for(var i=0;i<App.globalStaffMultipliers.length;i++)o.push(App.globalStaffMultipliers[i]);o.forEach(function(t){"Printing"===t.tab_name&&(t.subheading_name="Printing")});for(var s=_.unique(_.pluck(o,"tab_name")),c=[],l=0;l<s.length;l++)!function(t){var e=s[t],n={};n[e]=[];for(var r=o.filter(function(t){return t.tab_name===e}),a=_.unique(_.pluck(r,"subheading_name")),i=0;i<a.length;i++)!function(t){var o=a[t],i={};i[o]=[];var s=r.filter(function(t){return t.subheading_name===o});i[o]=s,n[e].push(i)}(i);c.push(n)}(l);for(var p=0;p<c.length;p++){var u=c[p],d=Object.keys(u)[0];p>0&&d3.select(".dv-container").append("div").attr("class","dv-divider");for(var f=d3.select(".dv-container").append("div").attr("class","dv-tab-content"),h=0;h<u[d].length;h++){var m=f.append("div").attr("class","dv-subheading-row").append("div").attr("class","dv-subheading-col"),g=u[d][h],v=Object.keys(g)[0];m.append("h3").attr("class","dv-h3").text(v);for(var b=0;b<g[v].length;b++){var A=g[v][b],y=A.name,C=m.append("div").attr("class","dv-item-row row").append("div").attr("class","dv-item-col col-sm-12"),x=C.append("div").attr("class","dv-item-name-container");x.append("div").attr("class","dv-item-name").append("b").text(y),x.append("div").attr("class","dv-description").text(A.description);var w=C.append("div").attr("class","dv-input-group");A.id?(w.append("input").attr("class","dv-input form-control").attr("gbcid",A.id),A.id.indexOf("gbc")>-1?("Overhead percentage"!==y&&w.append("span").attr("class","dv-currency"),w.append("span").attr("class","dv-cost-unit").text(" "+A.cost_unit)):w.append("span").attr("class","dv-cost-unit").text(" attendees"),w.append("div").attr("class","dv-default-text default-text")):w.append("div").attr("class","btn-group").selectAll("div").data(A.values).enter().append("div").attr("class","btn btn-secondary").classed("active",function(t){return t.toLowerCase()===User.buyOrLease}).text(function(t){return t}).on("click",function(t){$(this).addClass("active").siblings().removeClass("active"),User.buyOrLease=t.toLowerCase(),App.updateAllCosts()})}}}$(".dv-input").on("change",function(){var t=d3.select(this).attr("gbcid");t.indexOf("gbc")>-1?"gbc.overhead"===t?App.whoAmI.staff_overhead_perc=Util.getInputNumVal(this)/100:null!==t&&(App.globalBaseCosts.find(function(e){return e.id===t}).cost=Util.getInputNumVal(this)/a):App.globalStaffMultipliers.find(function(e){return e.id===t}).count=Util.getInputNumVal(this),r(t,this),App.updateAllCosts()}),d3.selectAll(".dv-input").each(function(){var t=d3.select(this),e=t.attr("gbcid");if(e.indexOf("gbc")>-1){if("gbc.overhead"===e)t.node().value=Util.comma(100*App.whoAmI.staff_overhead_perc);else if(null!==e){var n=App.globalBaseCosts.find(function(t){return t.id===e});t.node().value=Util.comma(n.cost*a)}}else{var o=App.globalStaffMultipliers.find(function(t){return t.id===e});t.node().value=Util.comma(o.count)}$(".dv-currency").text(App.whoAmI.currency_iso),r(e,this)}),$(".proceed-button").click(function(){return hasher.setHash("costs/p-1/1")})}}();