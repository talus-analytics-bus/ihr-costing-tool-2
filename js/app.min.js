const App={};(()=>{App.initialize=(callback)=>{ $('.nav-item').click(function(){hasher.setHash($(this).attr('page'));}); callback();}
App.initWho=()=>{ var blockModeColors={'':'transparent','default':'transparent','incomplete':'rgba(242,222,222,1)','custom':'rgba(252,248,227,1)'};
 
var blockLinks=d3.select('.block-link-container').selectAll('.block-link').data(blocksShowing).enter().append('div').attr('class','block-link').attr('level',function(d){return d.level;}).style('display',function(d){return(d.level>0)?'none':'block';}).classed('children-showing',function(d){if(d.level===0)return false;}).attr('block-name',function(d){return d.abbr;}).on('click',function(d){showBlock(d.abbr);});blockLinks.append('div').attr('class','block-link-title').html(function(d){return d.name;});blockLinks.append('div').attr('class','block-status').html(function(d){return d.status;});blockLinks.append('div').attr('class','block-link-cover'); d3.select('.block-link-container .block-link:first-child').append('img').attr('class','block-link-arrow').attr('src','img/chevron_right.png');var blocks={location:{esf:[3,6,7,12],isDefault:{location:true}},dex:{esf:[6,7],hazard:['flood','hurricane','ind','other'],isDefault:{dex:true}},population:{esf:[6,7],isDefault:{arp:true,sev:true,'vuln-pop':true,'pop-shelter':true,'pop-food':true},tooltipElements:{arp:'.impacted-pop-input',sev:'.se-vuln-input','vuln-pop':'.vuln-pop-input','pop-shelter':'.shelter-pop-input','pop-food':'.food-pop-input'},},'resource-dist':{blockName:'Resource Distribution',esf:[3,6,7],firstChild:'resource',children:{resource:{esf:[3,6,7],isDefault:{threshold:true,resource:true},tooltipElements:{threshold:'.distance-threshold',resource:'.original-resource-row'},tooltipShowFn:{resource:function(){d3.selectAll('.original-resource-row').each(function(d){if(App.isDistCenterResourcesDefault(d)===false||calculateIfActive(d)!==d.active){$(this).tooltipster('show');}else{$(this).tooltipster('hide');}});}}},prices:{esf:[6,7],isDefault:{waterPrice:true,mealsPrice:true},tooltipElements:{waterPrice:'.water-price-input',mealsPrice:'.meals-price-input',prWaterPrice:'.pr-water-price-input',prMealsPrice:'.pr-meals-price-input'}},needs:{esf:[6,7],isDefault:{waterNeeds:true,mealsNeeds:true},tooltipElements:{waterNeeds:'.water-needs-input',mealsNeeds:'.meals-needs-input'}},airtype:{esf:[7],isDefault:{airtype:true}},'transport-costs':{esf:[7],isDefault:{'transport-costs':true},tooltipElements:{'transport-costs':'.transport-costs-input'}}}},energy:{blockName:'Power Outages',esf:[6,12],firstChild:'eaglei',children:{eaglei:{esf:[6,12],isDefault:{eaglei:true}},household:{esf:[6,12],isDefault:{household:true},tooltipElements:{household:'.household-input'}}}},infrastructure:{blockName:'Infrastructure',esf:[3,12],firstChild:'hsip',children:{hsip:{esf:[3,12],isDefault:{hsip:true}},generator:{esf:[3,12],isDefault:{generator:true}}}}}; for(var name in blocks){if(blocks[name].hasOwnProperty('children')){for(var childName in blocks[name].children){blocks[name].children[childName].parent=name;}}} 
var blocksShowing=[];var addBlockToVar=function(name,block,level,parentAbbr){var isRelevant=false;for(var i=0;i<block.esf.length;i++){if(inputValues.esf.indexOf(String(block.esf[i]))>-1){isRelevant=true;break;}}
if(block.hazard&&block.hazard.indexOf(inputValues.hazard)===-1)isRelevant=false;if(isRelevant){var blockInfo={abbr:name,name:block.blockName?block.blockName:$('.'+name+'-block .block-title-title').text(),level:level,status:'default',};if(level===1)blockInfo.parentAbbr=parentAbbr;for(var ind in block)blockInfo[ind]=block[ind];blocksShowing.push(blockInfo);}
return isRelevant;};for(var name in blocks){var isRelevant=addBlockToVar(name,blocks[name],0);if(isRelevant&&blocks[name].hasOwnProperty('children')){for(var childName in blocks[name].children){addBlockToVar(childName,blocks[name].children[childName],1,name);}}}; var blockLinks=d3.select('.block-link-container').selectAll('.block-link').data(blocksShowing).enter().append('div').attr('class','block-link').attr('level',function(d){return d.level;}).style('display',function(d){return(d.level>0)?'none':'block';}).classed('children-showing',function(d){if(d.level===0)return false;}).attr('block-name',function(d){return d.abbr;}).on('click',function(d){showBlock(d.abbr);});blockLinks.append('div').attr('class','block-link-title').html(function(d){return d.name;});blockLinks.append('div').attr('class','block-status').html(function(d){return d.status;});blockLinks.append('div').attr('class','block-link-cover'); d3.select('.block-link-container .block-link:first-child').append('img').attr('class','block-link-arrow').attr('src','img/chevron_right.png');var updateBlockStatus=function(blockAbbr,defaultStatus,moduleName){var blockInfo=getBlockInfo(blockAbbr);var statuses=blockInfo.isDefault; if(typeof defaultStatus!=='undefined'){if(moduleName)statuses[moduleName]=defaultStatus;else statuses[blockAbbr]=defaultStatus;} 
for(var ind in statuses){ if(blockInfo.hasOwnProperty('tooltipElements')&&blockInfo.tooltipElements.hasOwnProperty(ind)){var tooltipEle=blockInfo.tooltipElements[ind];statuses[ind]?$(tooltipEle).removeClass('non-default'):$(tooltipEle).addClass('non-default'); if(blockAbbr===currBlockAbbr){if(blockInfo.hasOwnProperty('tooltipShowFn')&&blockInfo.tooltipShowFn.hasOwnProperty(ind)){blockInfo.tooltipShowFn[ind](statuses[ind]);}else{toggleInputTooltip(tooltipEle,statuses[ind]);}}}} 
var statusText=getBlockStatus(blockAbbr);var blockLink=d3.select('.block-link[block-name="'+blockAbbr+'"]');blockLink.datum().status=statusText;blockLink.select('.block-status').text((statusText==='default')?'':statusText);updateBlockLinkColor(blockInfo.abbr,blockLink);if(blockInfo.hasOwnProperty('isDefaultTextElements')){for(var ind in blockInfo.isDefaultTextElements){$(blockInfo.isDefaultTextElements[ind]).text(getBlockComponentStatus(blockInfo,ind));}} 
if(blockInfo.hasOwnProperty('parent'))updateBlockStatus(blockInfo.parent);}; var updateBlockLinkColor=function(blockAbbr,blockLinkEle){if(typeof blockLinkEle==='undefined')var blockLinkEle=d3.select('.block-link[block-name="'+blockAbbr+'"]');blockLinkEle.style('background',function(d){var bgColor=(blockAbbr===currBlockAbbr&&(d.status===''||d.status==='default'))?'#f0f0f0':blockModeColors[d.status];return'linear-gradient(to right, '+bgColor+', white)';});}; var toggleBlockTooltip=function(blockAbbr,show){var blockInfo=getBlockInfo(blockAbbr);if(blockInfo.hasOwnProperty('tooltipElements')){var tooltipElements=[];var tooltipEleDict=blockInfo.tooltipElements;for(var ind in tooltipEleDict){if(show){ if(blockInfo.hasOwnProperty('tooltipShowFn')&&blockInfo.tooltipShowFn.hasOwnProperty(ind)){blockInfo.tooltipShowFn[ind](blockInfo.isDefault[ind]);}else{if(!blockInfo.isDefault[ind])tooltipElements.push(tooltipEleDict[ind]);}}else{tooltipElements.push(tooltipEleDict[ind]);}}
var displayStr=show?'show':'hide';if($(tooltipElements.join(', ')).hasClass('tooltipstered'))$(tooltipElements.join(', ')).tooltipster(displayStr);}}; var showBlock=function(blockAbbr,animate){if(typeof animate==='undefined')var animate=true;var pastBlockAbbr=currBlockAbbr;var blockInfo=getBlockInfo(blockAbbr); var clickedSameOrParent=(blockAbbr===currBlockAbbr)||(blockInfo.hasOwnProperty('children')&&blockInfo.children.hasOwnProperty(currBlockAbbr));if(clickedSameOrParent)return; if(animate)$('.input-block-container .block').slideUp();else $('.input-block-container .block').hide();if(typeof pastBlockAbbr!=='undefined'){toggleBlockTooltip(pastBlockAbbr,false);$('.block-link[block-name="'+pastBlockAbbr+'"]').removeClass('active');} 
d3.selectAll('.block-link').style('border-top',function(d,i){return(i===0)?'1px solid #ccc':'none';}).style('border-bottom','1px solid #ccc'); currBlockAbbr=blockAbbr;if(blockInfo.hasOwnProperty('firstChild'))currBlockAbbr=blockInfo.firstChild; var blockLink=$('.block-link[block-name="'+currBlockAbbr+'"]').addClass('active');$('.block-link-arrow').appendTo(blockLink).show(); if(blockInfo.hasOwnProperty('children')&&!Util.isKeyInObject(blockInfo.children,pastBlockAbbr)){for(var childName in blockInfo.children){if(animate)$('.block-link[block-name="'+childName+'"]').slideDown();else $('.block-link[block-name="'+childName+'"]').show();}} 
if(typeof pastBlockAbbr!=='undefined'){var pastBlockInfo=getBlockInfo(pastBlockAbbr);if(pastBlockInfo.hasOwnProperty('parent')&&pastBlockInfo.parent!==blockInfo.parent&&pastBlockInfo.parent!==blockAbbr){var pastParentBlockInfo=getBlockInfo(pastBlockInfo.parent);hideBlockLinks(pastParentBlockInfo.children,animate);}else if(pastBlockInfo.hasOwnProperty('children')&&!Util.isKeyInObject(pastBlockInfo.children,blockAbbr)){hideBlockLinks(pastBlockInfo.children,animate);}}    
var selectionToShow=$('.'+currBlockAbbr+'-block');if(blockInfo.hasOwnProperty('extraBlocks')){var showExtraBlocks=true;if(blockInfo.hasOwnProperty('extraBlocksCond')){showExtraBlocks=blockInfo.extraBlocksCond();}
if(showExtraBlocks){var extraBlocks=blockInfo.extraBlocks;for(var i=0;i<extraBlocks.length;i++){selectionToShow=selectionToShow.add(extraBlocks[i]);}}}
if(animate)selectionToShow.slideDown();else selectionToShow.show();selectionToShow.trigger('block-open');if(animate)setTimeout(function(){toggleBlockTooltip(currBlockAbbr,true);},410);else toggleBlockTooltip(currBlockAbbr,true); if(currBlockAbbr==='eaglei')updateBlockStatus('eaglei',true); if(blockInfo.hasOwnProperty('children')||blockInfo.hasOwnProperty('parent')){blockLink.nextAll('[level="0"]:first').css('border-top','1px solid #ccc').prev().css('border-bottom','none');} 
if(typeof pastBlockAbbr!=='undefined')updateBlockLinkColor(pastBlockAbbr);updateBlockLinkColor(currBlockAbbr);}; var hideBlockLinks=function(blockNames,animate){for(var blockName in blockNames){if(animate)$('.block-link[block-name="'+blockName+'"]').slideUp();else $('.block-link[block-name="'+blockName+'"]').hide();}};var getBlockInfo=function(blockAbbr){for(var name in blocks){if(name===blockAbbr)return blocks[name];else if(blocks[name].hasOwnProperty('children')){for(var childName in blocks[name].children){if(childName===blockAbbr)return blocks[name].children[childName];}}}}; var getBlockStatus=function(blockAbbr){var blockInfo=getBlockInfo(blockAbbr);var status=(blockInfo.hasOwnProperty('completeText'))?blockInfo.completeText:'default';if(blockInfo.hasOwnProperty('children')){for(var childName in blockInfo.children){var childStatus=getBlockStatus(childName);if(childStatus==='incomplete'||childStatus==='custom'){return childStatus;}}}else{var statusObj=blockInfo.isDefault;for(var ind in statusObj){var componentStatus=getBlockComponentStatus(blockInfo,ind);if(componentStatus==='incomplete')return'incomplete';else if(componentStatus==='custom'&&status!=='custom'){status='custom';}}}
return status;}; var getBlockComponentStatus=function(blockInfo,componentName){if(typeof blockInfo==='undefined')var blockInfo=getBlockInfo(blockAbbr);if(blockInfo.isDefault[componentName]===false){if(blockInfo.hasOwnProperty('required')&&blockInfo.required.indexOf(ind)>-1){return'incomplete';}else{return'custom';}}else{return blockInfo.hasOwnProperty('completeText')?blockInfo.completeText:'default';}}; var isBlockOnPage=function(blockAbbr){for(var i=0;i<blocksShowing.length;i++){if(blocksShowing[i].abbr===blockAbbr)return true;}
return false;}; var toggleInputTooltip=function(element,isDefault){var $element=$(element);if($element.hasClass('tooltipstered')){$element.tooltipster(isDefault?'hide':'show');}};var currBlockAbbr; showBlock(blocksShowing[0].abbr,false);blockLinks.each(function(d){updateBlockStatus(d.abbr);}); $('.input-block-container .block-content, .input-block-container .block-description').css('display',function(){var contentHazardStr=$(this).attr('hazard');if(typeof contentHazardStr!=='undefined'){var contentHazards=contentHazardStr.split(',');return(contentHazards.indexOf(inputValues.hazard)===-1)?'none':'block';}}); if(isBlockOnPage('location')){ var countyClass='.search-county';var stateClass='.search-state-for-county';var addOptions=function(data,type,param){if(!param)var param={};if(!param.hasOwnProperty('refresh'))param.refresh=true;var cont=(type==='county')?countyClass:stateClass;var ele=(type==='county')?'.search-county-element':'.search-state-element';$(ele).remove();d3.select(cont).selectAll(ele).data(data).enter().append('option').attr('class',ele.slice(1)).attr('selected',function(d){if(d.selected)return true;}).attr('value',function(d){return d.abbr;}).html(function(d){return(type==='county')?d.abbr:d.name;});if(param.refresh){$(cont).multiselect('rebuild');}};var addOptionsForState=function(state_abbr,param){if(!param)var param={};var county_list=[];for(var fips in COUNTIES){if(COUNTIES[fips].state_abbr===state_abbr){county_list.push({abbr:COUNTIES[fips].county_abbr,selected:(inputValues.locations.indexOf(+fips)>-1)});}}
Util.sortObjects(county_list,'abbr');addOptions(county_list,'county',param);};var displayForState=function(state_abbr,param){if(!param)var param={};addOptionsForState(state_abbr,param);if(param.hasOwnProperty('refresh')&&param.refresh===false){$('.search-state-for-county option[value="'+state_abbr+'"]').attr('selected',true);}else{$(stateClass).multiselect('select',state_abbr,false);}};addOptions(STATES_UNIQ,'state',{refresh:false});if(inputValues.locations.length>0){displayForState(App.getLocationObject()[0].state_abbr,{refresh:false});} 
d3.select('.search-city').selectAll('option').data(CITIES_UNIQ).enter().append('option').attr('value',function(d){return d.fips;}).text(function(d){return d.name;}); var stateNames=Util.sortObjects(STATES_UNIQ.slice(0),'name');d3.select('.search-state').selectAll('option').data(stateNames).enter().append('option').attr('value',function(d){return d.abbr;}).text(function(d){return d.name;});}};})();